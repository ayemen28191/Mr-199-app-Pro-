# نظام مراقبة مخطط قاعدة البيانات - دليل شامل

## نظرة عامة 🎯

نظام متكامل لمراقبة واكتشاف الانحرافات في مخطط قاعدة البيانات (Schema Drift Detection) باللغة العربية. يتيح النظام مقارنة دقيقة بين مخطط قاعدة البيانات الفعلي والمخطط المتوقع في الكود، مع إنتاج تقارير تفصيلية والتكامل مع GitHub Actions للمراقبة التلقائية.

## الهدف الأساسي 🎪

- **كشف الانحرافات**: اكتشاف الاختلافات بين الكود وقاعدة البيانات الفعلية
- **التقارير التلقائية**: إنتاج تقارير JSON مفصلة مع التحليل الشامل  
- **الأتمتة**: دمج الفحص في سير العمل للفحص التلقائي
- **الأمان**: نسخ احتياطية وعمليات آمنة

## بنية المشروع 📁

```
├── scripts/                              # سكربتات النظام الأساسية
│   ├── generate-expected-schema.ts       # توليد المخطط المتوقع
│   ├── compare-expected-vs-db.ts        # مقارنة المخططات  
│   ├── backup-database.ts               # النسخ الاحتياطية
│   ├── setup-ddl-audit.ts              # إعداد تدقيق DDL
│   ├── run-commands.sh                  # أوامر التشغيل السريع
│   ├── expected_schema.json            # المخطط المتوقع (مُولّد)
│   └── schema_comparison_report.json   # تقرير المقارنة (مُولّد)
├── .github/workflows/
│   └── schema-check.yml                 # GitHub Actions workflow
├── shared/
│   └── schema.ts                        # تعريف مخطط قاعدة البيانات
└── docs/
    └── SCHEMA_MONITORING_SYSTEM.md     # هذا الملف
```

## الملفات الأساسية 📄

### 1. `scripts/generate-expected-schema.ts`
**الغرض**: توليد المخطط المتوقع من تعريفات Drizzle ORM

**الوظائف الرئيسية**:
- قراءة تعريفات الجداول من `shared/schema.ts`
- استخراج معلومات الأعمدة والأنواع والقيود
- إنتاج ملف JSON منظم بالمخطط المتوقع
- دعم جميع أنواع البيانات PostgreSQL

**طريقة العمل**:
```typescript
// يقرأ ملف المخطط ويحلل تعريفات pgTable
const tables = extractTablesFromSchema();
// يستخرج تفاصيل كل عمود
const columns = extractColumnDetails(table);
// ينتج ملف JSON منظم
generateExpectedSchemaFile();
```

**المخرجات**: `expected_schema.json` (حجم ~112KB)

### 2. `scripts/compare-expected-vs-db.ts`  
**الغرض**: مقارنة المخطط المتوقع مع قاعدة البيانات الفعلية

**الوظائف الرئيسية**:
- الاتصال بقاعدة البيانات باستخدام `@neondatabase/serverless`
- استخراج مخطط قاعدة البيانات من `information_schema`
- مقارنة شاملة للجداول والأعمدة والأنواع
- كشف الجداول المفقودة والإضافية
- تحليل الاختلافات في أنواع البيانات والقيود

**أنواع المقارنات**:
- **الجداول**: موجود/مفقود/إضافي
- **الأعمدة**: موجود/مفقود/نوع مختلف
- **الأنواع**: VARCHAR/TEXT/INTEGER/BOOLEAN إلخ
- **القيود**: NOT NULL/DEFAULT VALUES/PRIMARY KEY

**المخرجات**: `schema_comparison_report.json` (حجم ~175KB)

### 3. `scripts/backup-database.ts`
**الغرض**: إنشاء نسخ احتياطية شاملة من قاعدة البيانات

**الوظائف الرئيسية**:
- نسخ احتياطي لجميع الجداول أو جداول محددة
- حفظ البيانات والمخطط معاً
- ضغط البيانات الكبيرة تلقائياً
- تسمية الملفات بالتوقيت لسهولة التتبع

**أنواع النسخ الاحتياطية**:
- **شاملة**: جميع الجداول
- **انتقائية**: جداول محددة
- **مخطط فقط**: تعريفات الجداول بدون بيانات
- **بيانات فقط**: البيانات بدون مخططات

### 4. `scripts/setup-ddl-audit.ts`
**الغرض**: إعداد نظام تدقيق لتغييرات DDL

**الوظائف الرئيسية**:
- إنشاء جداول التدقيق
- إعداد المُشغِّلات (Triggers) لرصد التغييرات
- تسجيل جميع عمليات CREATE/ALTER/DROP
- تتبع المستخدم والوقت لكل تغيير

### 5. `scripts/run-commands.sh`
**الغرض**: واجهة موحدة لجميع أوامر النظام

**الأوامر المتاحة**:
```bash
# توليد المخطط المتوقع
./scripts/run-commands.sh gen:expected

# فحص المطابقة
./scripts/run-commands.sh check:schema  

# فحص CI شامل
./scripts/run-commands.sh schema:ci

# نسخة احتياطية كاملة  
./scripts/run-commands.sh backup:full

# إعداد التدقيق
./scripts/run-commands.sh setup:audit
```

## GitHub Actions Integration 🔄

### `.github/workflows/schema-check.yml`
**المُشغِّل**: عند كل Pull Request والدفع للفرع الرئيسي

**خطوات العمل**:
1. **Setup**: تثبيت Node.js والاعتماديات
2. **Generate**: توليد المخطط المتوقع من الكود
3. **Compare**: مقارنة مع قاعدة البيانات الفعلية  
4. **Report**: إنتاج تقرير وتحميله كـ Artifact
5. **Comment**: إضافة تعليق تلقائي في PR بالنتائج

**المتغيرات المطلوبة**:
- `DATABASE_URL`: رابط اتصال قاعدة البيانات
- `GITHUB_TOKEN`: للتعامل مع GitHub API

## التكوين التقني ⚙️

### قاعدة البيانات
- **النوع**: PostgreSQL (Supabase)
- **الاتصال**: `@neondatabase/serverless` مع WebSocket
- **المخطط**: `public` schema
- **الترميز**: UTF-8 مع دعم العربية

### الاعتماديات
```json
{
  "@neondatabase/serverless": "^0.10.4",
  "drizzle-orm": "latest", 
  "ws": "^8.0.0",
  "typescript": "^5.0.0"
}
```

### متطلبات النظام
- **Node.js**: 18.0+ 
- **TypeScript**: 5.0+
- **PostgreSQL**: 13.0+
- **ذاكرة**: 512MB+ (للبيانات الكبيرة)

## ملفات الإخراج 📋

### `expected_schema.json`
```json
{
  "metadata": {
    "generated_at": "2025-08-29T13:43:23.456Z",
    "total_tables": 37,
    "total_columns": 342
  },
  "tables": {
    "users": {
      "columns": {
        "id": {
          "type": "uuid",
          "nullable": false,
          "default": "gen_random_uuid()"
        }
      }
    }
  }
}
```

### `schema_comparison_report.json`
```json
{
  "status": "drift_detected",
  "compared_at": "2025-08-29T13:47:32.304Z", 
  "database_url_host": "helium",
  "missing_tables": [],
  "extra_tables": [],
  "mismatches": [
    {
      "table": "users",
      "column": "firstName", 
      "issue": "missing_column",
      "expected": "text",
      "description": "العمود firstName مفقود في جدول users"
    }
  ],
  "summary": {
    "total_issues": 42,
    "tables_with_issues": 8,
    "severity": "medium"
  }
}
```

## أنواع الانحرافات المكتشفة 🔍

### 1. **انحرافات الجداول**
- **جداول مفقودة**: موجودة في الكود، مفقودة في DB
- **جداول إضافية**: موجودة في DB، مفقودة في الكود  
- **أسماء مختلفة**: تباين في أسماء الجداول

### 2. **انحرافات الأعمدة**
- **أعمدة مفقودة**: مُعرَّفة في الكود، مفقودة في DB
- **أعمدة إضافية**: موجودة في DB، غير مُعرَّفة في الكود
- **أنواع مختلفة**: VARCHAR vs TEXT, INTEGER vs BIGINT
- **قيود مختلفة**: NOT NULL, DEFAULT VALUES

### 3. **انحرافات البيانات**  
- **أحجام مختلفة**: VARCHAR(255) vs VARCHAR(100)
- **دقة الأرقام**: DECIMAL(10,2) vs DECIMAL(12,4)
- **فهارس مفقودة**: Primary Keys, Foreign Keys, Indexes

## استراتيجيات المعالجة 🛠️

### عند اكتشاف انحراف:

1. **تحليل التقرير**: مراجعة `schema_comparison_report.json`
2. **تحديد الأولوية**: حسب نوع وخطورة الانحراف
3. **النسخ الاحتياطية**: قبل أي تعديل
4. **التطبيق التدريجي**: تعديل واحد في المرة
5. **اختبار شامل**: التحقق من عمل النظام

### أولويات المعالجة:
1. **أولوية عليا**: جداول مفقودة، أعمدة أساسية
2. **أولوية متوسطة**: أنواع بيانات مختلفة  
3. **أولوية منخفضة**: جداول إضافية، أعمدة اختيارية

## الأمان والاعتبارات 🔒

### الأمان:
- **النسخ الاحتياطية**: تلقائية قبل أي تعديل
- **الأذونات**: قراءة فقط لمعظم العمليات
- **التشفير**: جميع الاتصالات مُشفَّرة (SSL)
- **التدقيق**: تسجيل جميع العمليات

### الاعتبارات:
- **الأداء**: تجنب الفحص المتكرر للبيانات الكبيرة
- **التوقيت**: تشغيل الفحص خارج ساعات الذروة
- **الموارد**: مراقبة استهلاك الذاكرة والمعالج
- **التنبيهات**: إشعارات فورية للانحرافات الحرجة

## الاستكشاف والإصلاح 🔧

### مشاكل شائعة:

#### اتصال قاعدة البيانات
```bash
❌ خطأ: Error connecting to database
✅ الحل: التحقق من DATABASE_URL والشبكة
```

#### أذونات غير كافية  
```bash
❌ خطأ: permission denied for schema public
✅ الحل: التحقق من صلاحيات المستخدم
```

#### ذاكرة غير كافية
```bash
❌ خطأ: JavaScript heap out of memory  
✅ الحل: زيادة --max-old-space-size
```

### أوامر الصيانة:
```bash
# إعادة توليد المخطط
npm run schema:generate

# فحص شامل مع تفاصيل
npm run schema:check -- --verbose

# تنظيف الملفات المؤقتة
npm run schema:clean
```

## التطوير والتحسين 🚀

### إضافات مقترحة:
- **واجهة رسومية**: لوحة تحكم للمراقبة
- **تنبيهات ذكية**: Slack/Email للانحرافات الحرجة  
- **تقارير تاريخية**: تتبع الانحرافات عبر الزمن
- **إصلاح تلقائي**: اقتراحات لإصلاح الانحرافات البسيطة

### أفضل الممارسات:
- **فحص منتظم**: يومي أو أسبوعي حسب حجم المشروع
- **مراجعة الكود**: تضمين فحص المخطط في Code Reviews
- **بيئات متعددة**: فحص Development, Staging, Production
- **التوثيق**: تحديث التوثيق مع كل تغيير

## الخلاصة 📝

نظام مراقبة مخطط قاعدة البيانات يوفر:
- **مراقبة مستمرة** للتطابق بين الكود وقاعدة البيانات
- **كشف مبكر** للانحرافات قبل وصولها للإنتاج  
- **تقارير مفصلة** لسهولة التحليل والمعالجة
- **أتمتة كاملة** مع دمج CI/CD
- **أمان عالي** مع النسخ الاحتياطية والتدقيق

النظام جاهز للاستخدام الفوري ويوفر أساساً قوياً لضمان جودة وتماسك قاعدة البيانات في بيئة التطوير والإنتاج.

---
*تم إنشاء هذا التوثيق في: 29 أغسطس 2025*  
*آخر تحديث: تنظيف قاعدة البيانات وإزالة الجداول الإضافية - مطابقة 100%*