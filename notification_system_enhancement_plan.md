# ุฎุทุฉ ุฅุตูุงุญ ูุชุทููุฑ ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุชูุฏู

## ูุธุฑุฉ ุนุงูุฉ
ุฎุทุฉ ุดุงููุฉ ูุชุญููู ูุธุงู ุงูุฅุดุนุงุฑุงุช ุฅูู ูุธุงู ูุชูุฏู ูุฐูู ูุน ุฅููุงููุงุช ูุญุณููุฉ ูููุฑุงูุจุฉ ูุงูุชุญููู ูุงูุฃูุงู.

---

## ุฃูุฏุงู ุงูุฎุทุฉ

### ุงูุฃูุฏุงู ุงูุฃุณุงุณูุฉ
1. **ุฅุตูุงุญ ุงูุฏูุงู ุงููุงูุตุฉ** ูู NotificationService.ts
2. **ุฌุนู ูุธุงู ุงูููุงูุจ ุฏููุงูููููุง ูุขูููุง** (ุงูุชูููุฏุ ุงูุชุญููุ ุงูุนุฑุถ)
3. **ุชุนุฒูุฒ ุทุงุจูุฑ ุงูุฅุฑุณุงู** (retry, backoff, dead-letter, batching)
4. **ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** ููุฌูุฏ rollback ูู ุงูุนูููุงุช ุงูุญุณุงุณุฉ
5. **ุฅุถุงูุฉ ุฑุตุฏ ููุฑุงูุจุฉ ูุชูุฏูุฉ** + ุชูุจููุงุช ุชููุงุฆูุฉ ุนูุฏ ุงูุญุฑุงู ุงููุคุดุฑุงุช
6. **ุฅุถุงูุฉ ูุฏุฑุงุช ุฐูุงุก ุงุตุทูุงุนู** (ุงุฎุชุจุงุฑูุฉ): ุชุตููู ุฃููููุงุชุ ุชููุน ุฃูุถู ููุช ููุฅุฑุณุงู
7. **ุงุฎุชุจุงุฑุงุช ุดุงููุฉ** (Unit/Integration/E2E) ูุฃุชูุชุฉ CI
8. **ุชุญุณูู ุงูุฃุฏุงุก** (ููุฑุณุฉุ cachingุ ุงุณุชุนูุงูุงุช ูุญุณููุฉ)

---

## ุฃููููุงุช ุงูุนูู

### ุฃ. ุฃููููุฉ ุญุฑุฌุฉ (Critical) โ๏ธ

#### 1. ุฅุชูุงู ุฏูุงู ุงูููุงูุจ
- โ ุงููููุฉ: ุฅุถุงูุฉ ุฏูุงู ููููุฏุฉ ูู NotificationService.ts
- ๐ฏ ุงูุฏูุงู ุงููุทููุจุฉ:
  - `createNotificationTemplate()`
  - `updateTemplate()`
  - `validateTemplate()`
  - `renderTemplate()`
- ๐ ูุนุงููุฑ ุงููุจูู:
  - ุฅูุดุงุก ูุงูุจ ูุธูุฑ ูู ุฌุฏูู notification_templates
  - ูุญุงููุฉ ุฅูุดุงุก ูุงูุจ ููููุฏ ุงููุชุบูุฑุงุช => ูุดู ูุน ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
  - renderTemplate ูุง ูุณูุญ ุจุชูููุฐ ููุฏ ูููุฑุฌุน ูุตูุง ุขูููุง

#### 2. ุฅุตูุงุญ setup-security-notifications.ts
- โ ุงููููุฉ: ุฑุจุท ูุน notification_settings ุงูุฌุฏูุฏ
- ๐ฏ ุงููุทููุจ: ุชุญุฏูุซ ุงุณุชุฏุนุงุกุงุช API ูุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ููุงุณุจุฉ

#### 3. ุฅุถุงูุฉ ูุนุงููุงุช Transaction/Rollback
- โ ุงููููุฉ: ุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช ูู ุงูุนูููุงุช ุงูุญุณุงุณุฉ
- ๐ฏ ุงููุทููุจ: ูุณุงุฑุงุช ุงูุฅูุดุงุก ูุงูุฅุฑุณุงู ุชุณุชุฎุฏู transactions

#### 4. ุฅุตูุงุญ ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
- โ ุงููููุฉ: ุฅุถุงูุฉ structured logs ููุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- ๐ฏ ุงููุทููุจ: logs ุจู JSON format ูุน requestId, userId, notificationId

#### 5. ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ุฃุณุงุณูุฉ
- โ ุงููููุฉ: ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช ููุฎุฏูุงุช ุงูุญุฑุฌุฉ
- ๐ฏ ุงููุทููุจ: Unit tests ููู template service ูqueue worker

### ุจ. ุฃููููุฉ ุนุงููุฉ (High) ๐ฅ

#### 1. ุชุญุณูู ุทุงุจูุฑ ุงูุฅุฑุณุงู
- โ ุงููููุฉ: retry ูุน exponential backoff + dead-letter queue
- ๐ฏ ุงููุทููุจ: ูุนุงูุฌุฉ ูุชูุงุฒูุฉ ูุน ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูุฅุฑุณุงู

#### 2. ุชุญุณูู ุงูููุงุฑุณ ูุงูุงุณุชุนูุงูุงุช
- โ ุงููููุฉ: ุถุจุท ููุงุฑุณ ูุญุณุงุจ ุนุฏุฏ ุบูุฑ ุงูููุฑูุกุฉ ูุงูููุชุฑุฉ
- ๐ฏ ุงููุทููุจ: ุงุณุชุนูุงูุงุช ุณุฑูุนุฉ ููุญุณููุฉ

#### 3. ุฅุถุงูุฉ ุฌุฏูู ุงูููุงููุณ
- โ ุงููููุฉ: notification_metrics ูุชุชุจุน ุงููุฌุงุญ/ุงููุดู ูุงูlatency
- ๐ฏ ุงููุทููุจ: ุฑุตุฏ ุดุงูู ูุฃุฏุงุก ุงููุธุงู

#### 4. ุฅุดุนุงุฑุงุช Push
- โ ุงููููุฉ: ุฅุถุงูุฉ ูุธุงู ุฅุดุนุงุฑุงุช Push ููููุงุช ุฅุถุงููุฉ
- ๐ฏ ุงููุทููุจ: ุฏุนู ูุชุนุฏุฏ ุงููููุงุช

### ุฌ. ุฃููููุฉ ูุชูุณุทุฉ (Medium) ๐

#### 1. ูุธุงู ุงูุชุฎุฒูู ุงููุคูุช
- โ ุงููููุฉ: Caching ููููุชุฑุฉ ูุงูุนุฏุงุฏุงุช
- ๐ฏ ุงููุทููุจ: Redis ุฃู in-memory cache

#### 2. ูุงุฌูุฉ ุงูููุงูุจ ุงูุฏููุงููููุฉ
- โ ุงููููุฉ: ูุนุงููุฉ ูุน sandboxed rendering
- ๐ฏ ุงููุทููุจ: ูุงุฌูุฉ ุชูุงุนููุฉ ูุฅุฏุงุฑุฉ ุงูููุงูุจ

#### 3. ููุญุฉ ุงููุฑุงูุจุฉ
- โ ุงููููุฉ: Dashboard ูููุฑุงูุจุฉ
- ๐ฏ ุงููุทููุจ: Prometheus + Grafana ุฃู Sentry

### ุฏ. ุชุญุณููุงุช ูุณุชูุจููุฉ (Nice-to-have) ๐

#### 1. ุฌุฏููุฉ ุฐููุฉ
- โ ุงููููุฉ: ML-based scheduling / priority scoring
- ๐ฏ ุงููุทููุจ: ููุงุฐุฌ ุฐููุฉ ูุชุญุณูู ุงูุชูููุช

#### 2. ุชูุตูุงุช ุฐููุฉ
- โ ุงููููุฉ: AI ููุฅุดุนุงุฑุงุช ุงูุชู ูุฌุจ ุฅุฑุณุงููุง ุฃู ุชุฃุฌูููุง
- ๐ฏ ุงููุทููุจ: ูุธุงู ุชูุตูุงุช ูุชุทูุฑ

#### 3. ุชุตุฏูุฑ ุงูุชูุงุฑูุฑ
- โ ุงููููุฉ: ุชุตุฏูุฑ ุชูุงุฑูุฑ PDF/Excel
- ๐ฏ ุงููุทููุจ: ุชูุงุฑูุฑ ุดุงููุฉ ูุงุจูุฉ ููุชุตุฏูุฑ

---

## ุชุบููุฑุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูููุชุฑุญุฉ

### 1. ุฅุถุงูุฉ ุฃุนูุฏุฉ ูุงูุตุฉ

```sql
-- ุฅุถุงูุฉ last_attempt_at ุฅู ูู ููู ููุฌูุฏูุง
ALTER TABLE notification_queue
  ADD COLUMN IF NOT EXISTS last_attempt_at TIMESTAMP;

-- ุฅุถุงูุฉ executed_by ูู ai_system_recommendations
ALTER TABLE ai_system_recommendations
  ADD COLUMN IF NOT EXISTS executed_by VARCHAR;

-- ุชุฃูุฏ ูู ูุฌูุฏ retry_count
ALTER TABLE notification_queue
  ADD COLUMN IF NOT EXISTS retry_count INTEGER DEFAULT 0;
```

### 2. ุฅูุดุงุก ุฌุฏูู ุงูููุงููุณ

```sql
-- ุฌุฏูู ููุงููุณ ุงูุฃุฏุงุก
CREATE TABLE IF NOT EXISTS notification_metrics (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  notification_id VARCHAR REFERENCES notifications(id) ON DELETE SET NULL,
  recipient_id VARCHAR,
  delivery_method VARCHAR,
  status VARCHAR, -- pending/sent/failed
  sent_at TIMESTAMP,
  latency_ms INTEGER,
  failure_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. ููุงุฑุณ ูุชุญุณูู ุงูุฃุฏุงุก

```sql
CREATE INDEX IF NOT EXISTS idx_notification_queue_recipient_status 
  ON notification_queue(recipient_id, status);

CREATE INDEX IF NOT EXISTS idx_notifications_created_at 
  ON notifications(created_at);

CREATE INDEX IF NOT EXISTS idx_notification_read_states_user 
  ON notification_read_states(user_id, notification_id);

CREATE INDEX IF NOT EXISTS idx_notification_metrics_notification 
  ON notification_metrics(notification_id);
```

---

## ุจููุฉ ุฏูุงู ุงูููุงูุจ

### ูุชุทูุจุงุช ุงููุธุงู
- **variables**: ูุตูููุฉ ูู `{ name, type, required, example }`
- **ููุงูุจ ุขููุฉ**: ุงุณุชุฎุฏุงู Mustache-like placeholders: `{{user_name}}`
- **ุฃูุงู**: ููุน ุชูููุฐ ุฃู ููุฏ (no eval)

### ุงูุฏูุงู ุงููุทููุจุฉ

```typescript
// ุงููุธุงู ุงููุทููุจ ุชูููุฐู
export async function createNotificationTemplate(data: any)
export async function updateTemplate(id: string, data: any)
export function validateTemplateVariables(template: any, vars: Record<string, any>)
export function renderTemplate(titleTemplate: string, contentTemplate: string, vars: Record<string, any>)
```

---

## ุชุญุณูู ุทุงุจูุฑ ุงูุฅุฑุณุงู

### ุงููุชุทูุจุงุช
1. **ูุนุงูุฌุฉ ูุชูุงุฒูุฉ** ูุน ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูุฅุฑุณุงู
2. **retry ูุน exponential backoff** (1m, 2m, 4m)
3. **dead-letter queue** ุจุนุฏ N ูุญุงููุงุช
4. **ุณุฌูุงุช ููุตููุฉ** ูู notification_metrics

### ุงูุชุตููู
- ุงุณุชุฎุฏุงู database locks ูููุน ุงูุชุถุงุฑุจ
- ูุญุต ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู (ุณุงุนุงุช ุงูุตูุชุ ุงูููุทูุฉ ุงูุฒูููุฉ)
- ุชุณุฌูู ุดุงูู ูููุฌุงุญ ูุงููุดู
- ุฅุฏุงุฑุฉ ุฐููุฉ ูุฅุนุงุฏุฉ ุงููุญุงููุฉ

---

## ุงูุฃูุงู ูุงูุญูุงูุฉ

### ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ
1. **RLS (Row Level Security)** ุนูู notifications ูnotification_queue
2. **Rate limiting** ุนูู ุฅูุดุงุก ุงูุฅุดุนุงุฑุงุช ูุฅุฑุณุงููุง
3. **ุชุดููุฑ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ** ูู channels.config
4. **ููุน ุชูููุฐ ุงูููุฏ** ูู ุงูููุงูุจ

### ูุซุงู ุณูุงุณุฉ RLS

```sql
-- ุชูุนูู RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;

-- Policy: ุงููุณุชุฎุฏููู ูุฑูู ุฅุดุนุงุฑุงุชูู ูุงูุฅุฏุงุฑููู ูุฑูู ุงููู
CREATE POLICY user_can_select ON notifications
  FOR SELECT
  USING (created_by = current_setting('app.current_user_id')::varchar 
         OR EXISTS (SELECT 1 FROM user_roles ur 
                   WHERE ur.user_id = current_setting('app.current_user_id')::varchar 
                   AND ur.role = 'admin'));
```

---

## ุฎุทุฉ ุงูุชูููุฐ (ููุงู ูุงุจูุฉ ููุชูููุฐ)

### ุงููุฑุญูุฉ ุงูุฃููู (ุฃููููุฉ ุญุฑุฌุฉ)
- [x] **PR-001**: ุชูููุฐ NotificationTemplateService ูุงููุงู โ **ููุชูู**
  - โ ุฅุถุงูุฉ ุฏูุงู createNotificationTemplate, updateTemplate, validateTemplateVariables, renderTemplate
  - โ ูุธุงู ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช ูุน Zod
  - โ ุนุฑุถ ุขูู ููููุงูุจ ุจุงุณุชุฎุฏุงู Mustache (ูุง ูุณูุญ ุจุชูููุฐ ููุฏ)
  - โ ุฅุฏุงุฑุฉ ุดุงููุฉ ููููุงูุจ ูุน ุงูุจุญุซ ูุงูููุชุฑุฉ
- [ ] **PR-002**: ุฅุตูุงุญ setup-security-notifications.ts ๐ **ุฌุงุฑู ุงูุนูู**
- [ ] **PR-003**: ุฅุถุงูุฉ transaction management
- [ ] **PR-004**: ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก + structured logs
- [ ] **PR-005**: ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ุฃุณุงุณูุฉ

### ุงููุฑุญูุฉ ุงูุซุงููุฉ (ุฃููููุฉ ุนุงููุฉ)
- [ ] **PR-006**: ุชุญุณููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูููุงุฑุณ
- [ ] **PR-007**: ุชุญุณูู queue worker ูุน retry/backoff
- [ ] **PR-008**: ุฅุถุงูุฉ notification_metrics
- [ ] **PR-009**: ุชูุนูู ุฅุดุนุงุฑุงุช Push

### ุงููุฑุญูุฉ ุงูุซุงูุซุฉ (ุฃููููุฉ ูุชูุณุทุฉ)
- [ ] **PR-010**: ูุธุงู Caching
- [ ] **PR-011**: ูุงุฌูุฉ ุงูููุงูุจ ุงูุฏููุงููููุฉ
- [ ] **PR-012**: ููุญุฉ ุงููุฑุงูุจุฉ ูุงูุชูุจููุงุช

---

## ูุนุงููุฑ ุงููุฌุงุญ ุงูููุงุฆูุฉ

### โ Definition of Done
1. **ุฌููุน ุงูุฏูุงู ุงูููููุฏุฉ ุชุนูู** ูุชูุช ุชุบุทูุชูุง ุจูุญุฏุงุช ุงุฎุชุจุงุฑ
2. **ูุณุจุฉ ูุฌุงุญ ุงูุชุณููู โฅ 95%** ูุน ุงูุฎูุงุถ ุงูุฃุฎุทุงุก ูุงูุชูุฑุงุฑุงุช
3. **ููุญุฉ ูุฑุงูุจุฉ ุชุนูู** ุชุนุฑุถ ูุคุดุฑุงุช ุงูุฃุฏุงุก ูุน ุชูุจููุงุช ุนูุฏ ุชุฌุงูุฒ ุงูุนุชุจุงุช
4. **ุณูุงุณุฉ retry ูdead-letter** ููุซูุฉ ูุชุนูู ุจููุงุกุฉ
5. **RLS ูุณูุงุณุงุช ุฃูุงู** ููุทุจูุฉ ูููุซูุฉ
6. **ุฎุทูุท ุงุฎุชุจุงุฑ ูุงููุฉ** (Unit/Integration/E2E) ูู CI ูุน ูุนุฏู ูุฌุงุญ ููุจูู

---

## ููุงุญุธุงุช ุชูููุฐูุฉ

### ูุตุงุฆุญ ูููุฉ
1. **ุงุจุฏุฃ ุจุงูุฃููููุฉ ุงูุญุฑุฌุฉ** ูููุน ุฎุณุงุฆุฑ ุงูุจูุงูุงุช ูุฅุตูุงุญ ุฃูุจุฑ ุซุบุฑุฉ ูุธูููุฉ
2. **ุญุงูุธ ุนูู logs ููุตููุฉ ูstructured** ูุชุณููู ุงูุชุดุฎูุต ุงููุงุญู
3. **ุงุฎุชุจุฑ ูู ุชุบููุฑ ุจุนูุงูุฉ** ูุจู ุงูุงูุชูุงู ูููุฑุญูุฉ ุงูุชุงููุฉ
4. **ูุซูู ุฌููุน ุงูุชุบููุฑุงุช** ูุงููุฑุงุฑุงุช ุงูุชูููุฉ

### ุงูุฎุทูุงุช ุงูุชุงููุฉ ุงููุจุงุดุฑุฉ
1. ุชูููุฐ NotificationTemplateService.ts ูุน ุฌููุน ุงูุฏูุงู ุงูููููุฏุฉ
2. ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช Jest ููุชุญูู ูู ุนูู ุงูุฏูุงู
3. ุชุทุจูู ุชุญุณููุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงูููุงุฑุณ
4. ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุน structured logging

---

*ุชุงุฑูุฎ ุฅุนุฏุงุฏ ุงูุฎุทุฉ: 30 ุฃุบุณุทุณ 2025*  
*ุญุงูุฉ ุงููุดุฑูุน: ุฌุงูุฒ ููุชูููุฐ*  
*ุงูุฃููููุฉ: ุญุฑุฌุฉ - ุจุฏุก ููุฑู ูุทููุจ*