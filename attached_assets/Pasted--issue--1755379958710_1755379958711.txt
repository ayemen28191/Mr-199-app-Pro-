جميل — أحسنت التجميع. حرّكت لك الصياغة إلى مواصفات واضحة وجاهزة للصق في تذكرة (issue) أو إرسالها للمطوّر. تركتها منظمة، مع تعريف المشكلة، متطلبات وظيفية، معايير قبول (Acceptance Criteria)، أمثلة حسابية، ومقترحات واجهة/تصميم. احفظها أو انسخها مباشرة:

عنوان التذكرة

تحسين وتعديل مكون daily-expenses-bulk-export.tsx — عرض المصروفات اليومية وحساب المتبقي وفقاً للحالات المشار إليها في الصورة

وصف عام المشكلة

هناك عدة أخطاء ونواقص في عرض بيانات المصروفات اليومية وتصديرها. المطلوب تعديل عرض الجدول وحساب عمود "المتبقي" وإضافة بيانات وملاحظات وألوان واضحة لكل نوع عملية، واستبعاد بعض السجلات من جدول المصروفات اليومية وإظهارها في جدول المشتريات.

المتطلبات الوظيفية (مرقمة كما طلبت)

1. عرض تاريخ الترحيل في ملاحظة "المبلغ المرحل من سابق"

إذا كان نوع السطر "مرجعة/مرحلة من سابق" أو ما يعادلها، يجب أن تظهر قيمة المبلغ في عمود "الملاحظات" مع تاريخ الترحيل (مثلاً: مرحل من تاريخ 22/06/2025).



2. إضافة صفّ جديد عند وجود مبلغ مُرحّل من مشروع آخر مع اسم المشروع

إذا وردت قيمة مرحّلة من مشروع آخر، يجب أن يُنشأ صف جديد منفصل في جدول المصروفات اليومية بعنوان يوضح اسم المشروع المرحّل منه والمبلغ.

الملاحظة لهذا الصف تضم: مرحل من مشروع: <اسم المشروع>.



3. عرض مبالغ الحوالات (دخل/تحويل) بلون خلفية أخضر وتفاصيل في الملاحظة

أي سطر من نوع "حولة" أو "توريد" يجب أن يظهر مع خلفية خضرة (أو شريط/خانة خلفية) لتمييزه.

ملاحظة السطر يجب أن تحتوي على: حولة من: <اسم المرسل>، إلى: <اسم المستلم>، رقم الحولة: <رقم> وأي تفصيل إضافي متاح.



4. عرض المصروفات للحسابات الأخرى

سطور المصروفات التي تخص "حسابات أخرى" أو تصنيفات غير مرئية حالياً يجب أن تظهر في الجدول كصفوف عادية مع النوع المناسب (مثلاً: منصرف - حسابات أخرى) وقيمتها.



5. استبدال تسمية "نثريات" بـ "نقليات" عندما ينطبق

إذا كانت عملية مصنفة كـ "نقليات" يجب أن يظهر نص التصنيف "نقليات" وليس "نثريات". النظام يجب أن يتحقق من حقل التصنيف واستخدام التسمية الصحيحة.



6. إظهار حساب أجور/جور العمال مع عدد أيام العمل في عمود الملاحظات

لصفوف أجور العمال (مصروفات العمال)، يجب أن يكون هناك عمود ضمن الملاحظات أو عمود مخصص يظهر: عدد أيام العمل، ساعات/الفترة (مثال: العمل من 4:00 عصر وحتى 7:00 صباحاً — 3 أيام)، وأي معامل (مثل 1.75) إذا وُجد.

إذا البيانات مُخزنة كـ (ساعات/أيام/معامل)، اعرضها بالصيغة الواضحة كما في الصورة.



7. إضافة عمود "المتبقي" (Balance) يحسب رصيد كل صف بتتابع زمني

يتم حساب المتبقي كسيريّة تراكمية (running balance) طبقاً للقواعد التالية:

إذا كان السطر نوعه "مرحل" (إضافة/ترحيل) أو "توريد" (دخل) → يزيد الرصيد (يُضاف).

إذا كان السطر نوعه "منصرف" → ينقص الرصيد (يُطرح).

القاعدة الخاصة بالتجميع:

إذا كان السطر الأول هو مبلغ مرحل من سابق (مثلاً 2,000) → المتبقي في الصف الأول = 2,000.

إذا كان السطر الثاني هو مبلغ مرحّل من مشروع آخر (مثلاً 5,000) → المتبقي في الصف الثاني = 2,000 + 5,000 = 7,000.

إذا جاء بعدها دخل (حولة) بقيمة 25,000 → المتبقي = 7,000 + 25,000 = 32,000.

إذا جاء بعدها منصرف (مصروف المهندس) 7,000 → المتبقي = 32,000 − 7,000 = 25,000.

وهكذا حتى نهاية السجلات.



يجب أن يظهر المتبقي لكل صف بجانب السطر في عمود مستقل، ومجموع المتبقي في أسفل الجدول (المبلغ المتبقي النهائي).



8. قواعد سلوك الجمع والخصم التفصيلية (باختصار)

إذا type ∈ {مرحل، توريد، حولة، دخل} → المتبقي = المتبقي_السابق + المبلغ.

إذا type == منصرف → المتبقي = المتبقي_السابق − المبلغ.

ابدأ المتبقي_السابق بـ 0 ما لم يوجد صف ترحيل/بدأي يظهر كرأس (فحينها يبدأ بقيمته).

ترتيب الحساب يجب أن يكون حسب الترتيب الزمني/المرئي في الجدول (الترتيب الموجود لدى المستخدم).



9. المشتريات الآجلة يجب ألا تظهر في جدول المصروفات اليومية

سجلات المشتريات من نوع "آجل" يجب حجبها عن جدول المصروفات اليومية. بدلاً من ذلك تظل تظهر في جدول الأسفل (جدول المشتريات) مع عمود إضافي يحدّد نوعها: نوع الدفع ∈ {"نقد", "آجل", "توريد"} وفق ما هو مخزن في النظام.



10. ملاحظات أجور العمال تظهر كما في الصورة

أي حقل ملاحظة خاص بأجور يجب أن يعرض كامل تفاصيل العمل (الفترة، ساعات/أيام، معدل الضرب إن وُجد، مثال: العمل من الساعة 4:00 إلى 7:00 — 3 أيام — معامل 1.75).

إن كان هناك تنسيق معين في الصورة (المضاعف على يسار الخانة) فالتنسيق نفسه أو ما يقابله في الملاحظة يجب أن يظهر.




متطلبات عرضية / واجهة المستخدم

صفوف الحوالات/التوريد: خلفية خضراء خفيفة، ونص أسود واضح.

صفوف المنصرف: خلفية عادية أو تمييز بسيط (اختياري لون أحمر فاتح عند السحب الكبير).

عمود المتبقي: أرقام منسقة مع فواصل الآلاف، اللون الافتراضي أسود، وإذا صار سالب اعرض باللون الأحمر مع فاصلة سالبة -.

جدول المشتريات أسفل الصفحة: أضف عمود نوع الدفع يوضح (نقد/آجل/توريد). لا تكرر المشتريات الآجلة في جدول المصروفات اليومية.

زر/اختيار تصدير: عند تصدير إلى Excel أو PDF تأكد أن عمود "المتبقي" يُضاف ويطابق الحسابات المعروضة في الواجهة.


معايير القبول (Acceptance Criteria)

[ ] السطر الذي يمثل "المبلغ المرحل من سابق" يحتوي في عمود الملاحظات على تاريخ الترحيل.

[ ] إذا وُجد مبلغ مرحّل من مشروع آخر يظهر كسطر منفصل ويحمل اسم المشروع في العمود المخصص أو الملاحظة.

[ ] سطور الحوالات مرئية ومليئة بالتفاصيل (من، إلى، رقم الحوالة) وخلفيتها خضراء.

[ ] كل مصروف يظهر؛ ولا توجد فئات مخفية (مثلاً حسابات أخرى) ما لم تُصنف كآجل/مشتريات.

[ ] تسمية النقليات صحيحة (تظهر كـ "نقليات").

[ ] ملاحظات أجور العمال تعرض عدد أيام العمل وتفاصيل الفترة والمعامل كما في الصورة.

[ ] عمود المتبقي موجود ويحسب الرصيد التراكمي لكل صف بدقة حسب القاعدة الموضحة، وتطابق الأرقام مع المثال التطبيقي.

[ ] المشتريات الآجلة لا تظهر في جدول المصروفات اليومية، وتظهر فقط في جدول المشتريات مع عمود نوع الدفع.

[ ] عند تصدير الإكسل/باقي الصيغ، تحوي النتيجة كل الحقول أعلاه وتُطابق الواجهة.


أمثلة واختبار رقمي سريع (كما طلبت)

صف1: المرحل من سابق = 2,000 → المتبقي صف1 = 2,000

صف2: المرحل من مشروع آخر = 5,000 → المتبقي صف2 = 2,000 + 5,000 = 7,000

صف3: دخل (حولة) = 25,000 → المتبقي صف3 = 7,000 + 25,000 = 32,000

صف4: منصرف (مصروف المهندس) = 7,000 → المتبقي صف4 = 32,000 − 7,000 = 25,000
(تؤكد هذه الأمثلة سريان قاعدة الجمع والطرح التراكمية.)


اقتراح تنفيذ تقني قصير (مساعدة للمطوّر)

أثناء تحميل البيانات في الواجهة، رتب السجلات حسب date ثم حسب sequence كما يظهر في الواجهة.

احسب العمود running_balance باستخدام حلقة بسيطة (for) على السجل المرتب:

إذا type ∈ additions → balance += amount

إذا type == expense → balance -= amount


استبعد من العرض أي سجل purchase حيث payment_type == "آجل" (ولكن لا تحذفه من مصدر البيانات). بدلاً من ذلك ضع الفلتر عند عرض جدول المصروفات اليومية.

امكانية إعادة استخدام نفس لوجيك الحساب في تصدير الإكسل بحيث تكون الأرقام متطابقة.


ملاحظات نهائية / أولوية

أرتّب العمل حسب الأولوية: 1) عمود المتبقي (حساب متسلسل) + قواعد الجمع/الطرح، 2) عرض الحوالات بالخلفية الخضراء + تفاصيل الملاحظة، 3) إظهار أجور العمال مع تفاصيل الأيام، 4) استبعاد المشتريات الآجلة من جدول المصروفات اليومية وإضافتها بعمود النوع في جدول المشتريات، 5) بقية التنبيهات والتسميات (نقليات، حسابات أخرى).

أرفق مع التذكرة لوج (export) أو مقتطف JSON من بيانات اليوم الذي في الصورة إن أمكن، حتى أتمكن من التحقق بسهولة من التطابق بعد التعديل.



---

هل تريد أن أحول هذا النص إلى تذكرة جاهزة بصيغة GitHub issue (مع أقسام Steps to reproduce و Expected و Actual و Screenshots)؟ أم تريد أن أضيف مثال JSON/SQL لخط حساب المتبقي يمكن لصاحب الـ backend لصقه؟

