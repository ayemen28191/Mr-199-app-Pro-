import React, { useEffect, useState } from 'react';  /**  * ToolDetailsDrawer.tsx  * ููููู React (TypeScript) ูุนุฑุถ ุชูุงุตูู ุฃุฏุงุฉุ ูุชุถูู ุชุจููุจุงุช Overview | Movements | Maintenance  * ููุญุชูู ุนูู ุงูุฃุฒุฑุงุฑ ุงูุฃุณุงุณูุฉ: Transfer, Return, Consume, Schedule Maintenance, Print  * ูุนุชูุฏ ุนูู TailwindCSS ูู ุงูุชุตููู (mobile-first).  *  * ููุงุญุธุงุช ุชูููุฐูุฉ:  * - ุงุณุชุฏุนุงุกุงุช API ููุถูุนุฉ ููุซุงู ุจุงุณุชุฎุฏุงู fetch. ูู ูุดุฑูุน ุญูููู ุงุณุชุนูู axios ุฃู fetch wrapper ูุน auth headers.  * - ูู ุนูููุฉ ุญุณุงุณุฉ ุชุณุชุฎุฏู idempotencyKey ูุชุฌูููุจ ุชูุฑุงุฑ ุงูุนูููุงุช ุนูุฏ ุฅุนุงุฏุฉ ุงูุฅุฑุณุงู (mobile offline retries).  * - ูู ุชุบููุฑ ูุณุชุฎุฏู optimistic UI ุญูุซ ููุงุณุจุ ููุชุนุงูู ูุน ุฃุฎุทุงุก rollback.  */  type UUID = string;  type LocationType = 'warehouse' | 'project' | 'external' | 'none';  type Tool = {   id: UUID;   name: string;   sku?: string;   status: string;   is_tool: boolean;   is_consumable: boolean;   purchase_price?: number;   acquisition_date?: string;   metadata?: any;   image_urls?: string[]; };  type StockItem = {   id: UUID;   tool_id: UUID;   location_type: LocationType;   location_id?: UUID | null;   quantity: number; };  type Movement = {   id: UUID;   tool_id: UUID;   from_type?: LocationType;   from_id?: UUID | null;   to_type?: LocationType;   to_id?: UUID | null;   quantity: number;   movement_type: string;   performed_by?: UUID;   performed_at: string;   notes?: string; };  // --- Helper: API wrapper (basic) --- async function callApi(path: string, opts: RequestInit = {}) {   const base = '/api'; // ุงุถุจุท ุฅู ูุฒู   const res = await fetch(base + path, {     headers: { 'Content-Type': 'application/json' },     credentials: 'include',     ...opts,   });   if (!res.ok) {     const text = await res.text();     throw new Error(text || res.statusText);   }   // ุจุนุถ ุงูู endpoints ูุฏ ุชุฑุฌุน 204   if (res.status === 204) return null;   return res.json(); }  // --- Utility --- function uid() {   // idempotency key helper   return 'key_' + Math.random().toString(36).slice(2) + Date.now().toString(36); }  // --- Props --- type Props = {   toolId: UUID | null;   open: boolean;   onClose: () => void;   currentLocation?: { type: LocationType; id?: UUID | null } | null; // ุงููููุน ุงูุฐู ูุนุฑุถ ููู ุงููุณุชุฎุฏู ุงููุงุฆูุฉ (ูุซู ุงููุดุฑูุน)   onUpdate?: () => void; // callback ูุฅุนูุงู ุงูุตูุญุฉ ุงูุฃู ุจุชุญุฏูุซุงุช };  export default function ToolDetailsDrawer({ toolId, open, onClose, currentLocation, onUpdate }: Props) {   const [tool, setTool] = useState(null);   const [stocks, setStocks] = useState([]);   const [movements, setMovements] = useState([]);   const [loading, setLoading] = useState(false);   const [activeTab, setActiveTab] = useState<'overview' | 'movements' | 'maintenance'>('overview');    // Modals state   const [showTransfer, setShowTransfer] = useState(false);   const [showReturn, setShowReturn] = useState(false);   const [showConsume, setShowConsume] = useState(false);   const [showMaintenance, setShowMaintenance] = useState(false);    // Transfer form state   const [transferToType, setTransferToType] = useState('project');   const [transferToId, setTransferToId] = useState(null);   const [transferQty, setTransferQty] = useState(1);   const [transferNotes, setTransferNotes] = useState('');    // Return form state   const [returnToWarehouseId, setReturnToWarehouseId] = useState(null);   const [returnNotes, setReturnNotes] = useState('');    // Consume form state   const [consumeQty, setConsumeQty] = useState(1);   const [consumeReason, setConsumeReason] = useState('');    // Maintenance form   const [maintenanceNotes, setMaintenanceNotes] = useState('');   const [maintenanceNextDue, setMaintenanceNextDue] = useState(null);   const [maintenanceCost, setMaintenanceCost] = useState(null);    // Errors   const [error, setError] = useState(null);    // Load details when toolId or open changes   useEffect(() => {     if (!open || !toolId) return;     setLoading(true);     setError(null);     (async () => {       try {         const data = await callApi(`/tools/${toolId}`);         setTool(data.tool ?? data);         setStocks(data.stock_by_location ?? data.stocks ?? []);         // fetch movements separately         const mv = await callApi(`/tools/${toolId}/movements?limit=50`);         setMovements(mv || []);       } catch (e: any) {         setError(e.message || 'ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุฃุฏุงุฉ');       } finally {         setLoading(false);       }     })();   }, [toolId, open]);    // Helper to update stock locally and notify parent   function applyLocalStockUpdate(newStocks: StockItem[]) {     setStocks(newStocks);     if (onUpdate) onUpdate();   }    // --- Actions: Transfer ---   async function handleConfirmTransfer() {     if (!tool) return;     setError(null);     const idempotencyKey = uid();     const payload = {       to_type: transferToType,       to_id: transferToId,       quantity: transferQty,       movement_type: 'transfer',       performed_by: null, // server will infer from session       notes: transferNotes,       idempotency_key: idempotencyKey,     };      // Optimistic UI: adjust local stocks     const fromEntry = stocks.find(s => s.location_type === (currentLocation?.type ?? 'project') && s.location_id === (currentLocation?.id ?? null));     const destKey = `${transferToType}:${transferToId}`;     const newStocks = stocks.map(s => ({ ...s }));      try {       // check availability locally       if (!fromEntry || fromEntry.quantity < transferQty) {         throw new Error(`ุงููููุฉ ุบูุฑ ูุงููุฉ (ุงููุชููุฑ: ${fromEntry ? fromEntry.quantity : 0})`);       }       // optimistic change       newStocks.forEach(s => {         if (s.id === fromEntry.id) s.quantity = s.quantity - transferQty;       });       // if dest exists, increase otherwise push       const dest = newStocks.find(s => s.location_type === transferToType && s.location_id === transferToId);       if (dest) dest.quantity += transferQty;       else newStocks.push({ id: uid(), tool_id: tool.id, location_type: transferToType, location_id: transferToId, quantity: transferQty });        applyLocalStockUpdate(newStocks);        // call API       await callApi(`/tools/${tool.id}/transfer`, {         method: 'POST',         body: JSON.stringify(payload),       });        // fetch latest movements       const mv = await callApi(`/tools/${tool.id}/movements?limit=20`);       setMovements(mv || movements);        setShowTransfer(false);     } catch (e: any) {       // rollback optimistic       setError(e.message || 'ูุดู ุงูููู');       // refetch stocks from server to ensure consistency       try {         const data = await callApi(`/tools/${tool?.id}`);         setStocks(data.stock_by_location ?? data.stocks ?? []);       } catch (_) {}     }   }    // --- Actions: Return ---   async function handleConfirmReturn() {     if (!tool) return;     setError(null);     const payload = {       to_type: 'warehouse',       to_id: returnToWarehouseId,       quantity: 1, // default for unique tool; in UI ูููู ุชุนุฏูู       movement_type: 'return',       notes: returnNotes,       idempotency_key: uid(),     };     try {       // call API       await callApi(`/tools/${tool.id}/return`, { method: 'POST', body: JSON.stringify(payload) });       // refresh       const data = await callApi(`/tools/${tool.id}`);       setStocks(data.stock_by_location ?? data.stocks ?? []);       const mv = await callApi(`/tools/${tool.id}/movements?limit=20`);       setMovements(mv || movements);       setShowReturn(false);     } catch (e: any) {       setError(e.message || 'ูุดู ุงูุฅุฑุฌุงุน');     }   }    // --- Actions: Consume ---   async function handleConsume() {     if (!tool) return;     setError(null);     const payload = {       quantity: consumeQty,       reason: consumeReason,       movement_type: 'consume',       idempotency_key: uid(),     };     try {       // optimistic adjust local       const source = stocks[0] ?? null;       const newStocks = stocks.map(s => ({ ...s }));       if (source) {         if (source.quantity < consumeQty) throw new Error(`ุงููููุฉ ุบูุฑ ูุงููุฉ (ุงููุชููุฑ: ${source.quantity})`);         newStocks[0].quantity = newStocks[0].quantity - consumeQty;         applyLocalStockUpdate(newStocks);       }       await callApi(`/tools/${tool.id}/consume`, { method: 'POST', body: JSON.stringify(payload) });       const data = await callApi(`/tools/${tool.id}`);       setStocks(data.stock_by_location ?? data.stocks ?? []);       const mv = await callApi(`/tools/${tool.id}/movements?limit=20`);       setMovements(mv || movements);       setShowConsume(false);     } catch (e: any) {       setError(e.message || 'ูุดู ุงูุนูููุฉ');       try {         const data = await callApi(`/tools/${tool?.id}`);         setStocks(data.stock_by_location ?? data.stocks ?? []);       } catch (_) {}     }   }    // --- Actions: Schedule/Log Maintenance ---   async function handleScheduleMaintenance() {     if (!tool) return;     const payload = {       notes: maintenanceNotes,       next_due_date: maintenanceNextDue,       cost: maintenanceCost,       idempotency_key: uid(),     };     try {       await callApi(`/tools/${tool.id}/maintenance`, { method: 'POST', body: JSON.stringify(payload) });       // refresh maintenance tab by refetching movements or a dedicated maintenance endpoint       const mt = await callApi(`/tools/${tool.id}/maintenance_logs`);       // ุฅุฐุง ุฃุฑุฏูุง: ุฏูุฌ ูู movements ุฃู ูุถุน ุญุงูุฉ       setShowMaintenance(false);     } catch (e: any) {       setError(e.message || 'ูุดู ุชุณุฌูู ุงูุตูุงูุฉ');     }   }    // --- Print / Export ---   async function handlePrintInventory() {     if (!tool) return;     // ูุชุญ ุฑุงุจุท ุงูู PDF ูู ุชุจููุจ ุฌุฏูุฏ     window.open(`/api/reports/tool-inventory?toolId=${tool.id}`, '_blank');   }    // --- Render helpers ---   function OverviewTab() {     if (!tool) return 
ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฃุฏุงุฉ.
;     return (       
         
           
             {tool.image_urls && tool.image_urls.length > 0 ? (               {tool.name}             ) : (               
ุตูุฑุฉ
             )}           
           
             
### {tool.name}
             
SKU: {tool.sku ?? '-'}
             
ุงูุญุงูุฉ: {tool.status}
             
ุณุนุฑ ุงูุดุฑุงุก: {tool.purchase_price ?? '-'} 
             
ูููุน ุงูุฃุฏูุงุช (stock):
             
               {stocks.map(s => (                 
-                    
{s.location_type}{s.location_id ? ` - ${s.location_id}` : ''}
                   
{s.quantity}
                 
               ))}             

           
         
          
            setShowTransfer(true)} className="px-3 py-2 bg-blue-600 text-white rounded">ููู            setShowReturn(true)} className="px-3 py-2 bg-green-600 text-white rounded">ุฅุฑุฌุงุน            setShowConsume(true)} className="px-3 py-2 bg-red-600 text-white rounded">ุงุณุชููุงู/ููุฏุงู            setShowMaintenance(true)} className="px-3 py-2 bg-yellow-500 text-black rounded">ุตูุงูุฉ           ุทุจุงุนุฉ ูุดู         
       
     );   }    function MovementsTab() {     return (       
         {movements.length === 0 ? (           
ูุง ุชูุฌุฏ ุญุฑูุงุช ุญุชู ุงูุขู.
         ) : (           
             {movements.map(m => (               
-                  
                   
{new Date(m.performed_at).toLocaleString()}
                   
{m.movement_type}
                 
                 
ูู: {m.from_type ?? '-'} {m.from_id ? `(${m.from_id})` : ''} โ ุฅูู: {m.to_type ?? '-'} {m.to_id ? `(${m.to_id})` : ''}
                 
ูููุฉ: {m.quantity} ยท ููุงุญุธุฉ: {m.notes ?? '-'}
               
             ))}           

         )}       
     );   }    function MaintenanceTab() {     return (       
         
ุณุฌู ุงูุตูุงูุฉ:
         {/* ูู ุชุทุจูู ุญูููู ูุนุฑุถ ุจูุงูุงุช ูู endpoint ูุฎุตุต */}         
ูุง ุชูุฌุฏ ุณุฌูุงุช ุตูุงูุฉ ููุนุฑุถ ุญุงููุงู.
       
     );   }    // --- Drawer UI ---   if (!open) return null;    return (     
       {/* backdrop */}       
        
         
           
             ุฅุบูุงู             
## ุชูุงุตูู ุงูุฃุฏุงุฉ
           
           
             ุทุจุงุนุฉ           
         
          {loading ? (           
ุฌุงุฑู ุงูุชุญููู...
         ) : error ? (           
{error}
         ) : (           
             
               
                  setActiveTab('overview')} className={`px-3 py-2 ${activeTab === 'overview' ? 'border-b-2 border-blue-600' : ''}`}>ูุธุฑุฉ ุนุงูุฉ                  setActiveTab('movements')} className={`px-3 py-2 ${activeTab === 'movements' ? 'border-b-2 border-blue-600' : ''}`}>ุณุฌู ุงูุญุฑูุงุช                  setActiveTab('maintenance')} className={`px-3 py-2 ${activeTab === 'maintenance' ? 'border-b-2 border-blue-600' : ''}`}>ุตูุงูุฉ               
                
                 {activeTab === 'overview' && }                 {activeTab === 'movements' && }                 {activeTab === 'maintenance' && }               
             
           
         )}          
ูุนูููุงุช ุฅุถุงููุฉ: ุนูููุงุช ุงูุชุนุฏูู ุชูุณุฌู ูู ุงูุณุฌู (audit) ุชููุงุฆูุงู.
       
        {/* Modals: Transfer */}       {showTransfer && (         
           
 setShowTransfer(false)} />           
             
### ููู ุงูุฃุฏุงุฉ
             
               ุงููุฌูุฉ               
                  setTransferToType(e.target.value as LocationType)} className="border rounded p-2 flex-1">                   ูุดุฑูุน                   ูุฎุฒู                   ุฎุงุฑุฌ                                   setTransferToId(e.target.value)} className="border rounded p-2 w-48" />               
                ุงููููุฉ                setTransferQty(Number(e.target.value))} className="border rounded p-2 w-32" />                ููุงุญุธุฉ                setTransferNotes(e.target.value)} className="border rounded p-2 w-full" />                <div className="flex gap-2 justify-end mt-3">                 <button onClick={() => setShowTransfer(false)} className="px-3 py-2 border rounded">ุฅูุบุงุก</button>                 <button onClick={handleConfirmTransfer} className="px-3 py-2 bg-blue-600 text-white rounded">ุชุฃููุฏ ุงูููู</button>               </div>             </div>           </div>         </div>       )}        {/* Return Modal */}       {showReturn && (         <div className="fixed inset-0 z-60 flex items-end md:items-center justify-center p-4">           <div className="absolute inset-0 bg-black/30" onClick={() => setShowReturn(false)} />           <div className="relative bg-white w-full max-w-xl rounded shadow p-4">             <h3 className="text-lg font-medium">ุฅุฑุฌุงุน ุงูุฃุฏุงุฉ</h3>             <div className="mt-3 space-y-2">               <label className="block text-sm">ุฅูู ูุฎุฒู (id)</label>               <input placeholder="warehouse id" value={returnToWarehouseId ?? ''} onChange={e => setReturnToWarehouseId(e.target.value)} className="border rounded p-2 w-full" />                <label className="block text-sm">ููุงุญุธุฉ</label>               <textarea rows={2} value={returnNotes} onChange={e => setReturnNotes(e.target.value)} className="border rounded p-2 w-full" />                <div className="flex gap-2 justify-end mt-3">                 <button onClick={() => setShowReturn(false)} className="px-3 py-2 border rounded">ุฅูุบุงุก</button>                 <button onClick={handleConfirmReturn} className="px-3 py-2 bg-green-600 text-white rounded">ุชุฃููุฏ ุงูุฅุฑุฌุงุน</button>               </div>             </div>           </div>         </div>       )}        {/* Consume Modal */}       {showConsume && (         <div className="fixed inset-0 z-60 flex items-end md:items-center justify-center p-4">           <div className="absolute inset-0 bg-black/30" onClick={() => setShowConsume(false)} />           <div className="relative bg-white w-full max-w-md rounded shadow p-4">             <h3 className="text-lg font-medium">ุงุณุชููุงู / ููุฏุงู</h3>             <div className="mt-3 space-y-2">               <label className="block text-sm">ุงููููุฉ</label>               <input type="number" min={1} value={consumeQty} onChange={e => setConsumeQty(Number(e.target.value))} className="border rounded p-2 w-32" />                <label className="block text-sm">ุงูุณุจุจ / ููุงุญุธุฉ</label>               <textarea rows={2} value={consumeReason} onChange={e => setConsumeReason(e.target.value)} className="border rounded p-2 w-full" />                <div className="flex gap-2 justify-end mt-3">                 <button onClick={() => setShowConsume(false)} className="px-3 py-2 border rounded">ุฅูุบุงุก</button>                 <button onClick={handleConsume} className="px-3 py-2 bg-red-600 text-white rounded">ุชุฃููุฏ ุงูุงุณุชููุงู</button>               </div>             </div>           </div>         </div>       )}        {/* Maintenance Modal */}       {showMaintenance && (         
           
 setShowMaintenance(false)} />           
             
### ุชุณุฌูู / ุฌุฏููุฉ ุตูุงูุฉ
             
               ููุงุญุธุฉ                setMaintenanceNotes(e.target.value)} className="border rounded p-2 w-full" />                ุงูุชุงุฑูุฎ ุงูุชุงูู ููุตูุงูุฉ                setMaintenanceNextDue(e.target.value)} className="border rounded p-2" />                ุงูุชูููุฉ (ุงุฎุชูุงุฑู)                setMaintenanceCost(Number(e.target.value))} className="border rounded p-2 w-40" />                
                  setShowMaintenance(false)} className="px-3 py-2 border rounded">ุฅูุบุงุก                 ุญูุธ ุงูุตูุงูุฉ               
             
           
         
       )}      
   ); } 
ุชูุงู โ ุฌูุฒุช ูู ููููู React ูุงูู ุจุงุณู **ToolDetailsDrawer.tsx** (ูุน ุชุนูููุงุช ุจุงูุนุฑุจูุ ุชูุนูู Tailwindุ ูุงุณุชุฏุนุงุกุงุช API ูุน ููุทู optimistic updates ู idempotency). ููููู ุฑุคูุฉ ุงูููู ุงูุขู ุนูู ุงูููุญุฉ ุงูุฌุงูุจูุฉ โ ุงุณูู: **Tool Details Drawer**.
 
ูู ุชุฑูุฏ ุฃุถูู ูุณุฎุฉ TypeScript ุฃูุซุฑ ุชุดุฏููุฏูุง (ูุน ูุงุฌูุงุช ููุตููุฉ)ุ ุฃู ุฃุตูุน ุฃูุถูุง ููููู `TransferList` ูููุตู ูููู ุงุฎุชุจุงุฑุงุช E2E ุฌุงูุฒ ููุฑูู ุงููQAุ


ุชูุงู โ
ุฎูููุง ูุถูู ุตูุญุฉ ุงููุนุฏุงุช ูุงูุฃุฏูุงุช ูู ุชุทุจููู ูุน ุฑุจุทูุง ุจุงููุดุงุฑูุน. ุงูุตูุญุฉ ุณุชุณูุญ ูู:

๐ฆ ุฅุถุงูุฉ ุงููุนุฏุงุช (ุงูุงุณู + ุงูุฑูู ุงูุชุณูุณูู ุฃู ุงูููุฏ + ุงููููุฉ + ููุงุญุธุงุช).

๐ ุฑุจุท ุงููุนุฏุงุช ุจูุดุฑูุน ูุญุฏุฏ ุนูุฏ ููููุง.

๐ ุนุฑุถ ุงููุนุฏุงุช ุงูุชู ุชู ุฅุฑุณุงููุง ูููุดุฑูุน ูุน ุญุงูุฉ (ููุฌูุฏุฉ / ุชู ุฅุฑุฌุงุนูุง).

๐ ุงูุจุญุซ ุฃู ุงูุชุตููุฉ ุญุณุจ ุงููุดุฑูุน ุฃู ุญุงูุฉ ุงูุฃุฏุงุฉ.


ุงูุฎุทูุงุช:

1. ุฅูุดุงุก ุฌุฏูู ุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณู ูุซูุงู equipments ูุญุชูู ุนูู:

id (ููุชุงุญ ุฑุฆูุณู)

name (ุงุณู ุงูุฃุฏุงุฉ)

code (ุงูุฑูู ุงูุชุณูุณูู ุฃู ุฑูู ุชุนุฑูู)

quantity (ุงูุนุฏุฏ)

notes (ููุงุญุธุงุช)

status (ููุฌูุฏุฉุ ูุณุชุฎุฏูุฉุ ุชู ุฅุฑุฌุงุนูุง)

project_id (ูุฑุจุท ุงูุฃุฏุงุฉ ุจุงููุดุฑูุน)



2. ุฅูุดุงุก ุตูุญุฉ ูุงุฌูุฉ ูุนุฑุถ ูุฅุฏุงุฑุฉ ุงููุนุฏุงุช:

ุฒุฑ ุฅุถุงูุฉ ูุนุฏุงุช ุฌุฏูุฏุฉ.

ูุงุฆูุฉ ุจุฌููุน ุงููุนุฏุงุช ุงููุฑุชุจุทุฉ ุจูุดุฑูุน ูุญุฏุฏ.

ุฃุฒุฑุงุฑ (ุชุนุฏูู โ ุญุฐู โ ุชุบููุฑ ุงูุญุงูุฉ).



3. ุนูุฏ ุชุญุฏูุฏ ูุดุฑูุน โ ูุธูุฑ ุฎูุงุฑ "ุฅุถุงูุฉ ูุนุฏุงุช" ูุชุญุฏูุฏ ุงููููุฉ.




---

ุชุญุจ ุฃูุชุจ ูู ููุฏ ุงูุฌุฏูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช + API + ุตูุญุฉ React ุฌุงูุฒุฉ ุนุดุงู ุชุฏูุฌูุง ูู ุชุทุจูููุ

