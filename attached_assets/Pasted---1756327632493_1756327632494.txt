# Ø®Ø·Ø© Ø¨Ø±ÙˆÙ…Ø¨ØªØ§Øª ÙˆÙ…ÙˆØ§ØµÙØ§Øª Ø¹Ù…Ù„ÙŠØ© Ù„Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ø§Ù„ØªØ­Ù‚Ù‚ØŒ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù…ØªÙˆØ§ÙÙ‚ Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙˆÙŠØ¨)
 
Ø¬Ù…ÙŠÙ„ â€” Ø³Ø£Ø¹Ø·ÙŠÙƒ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† **Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨ØªØ§Øª** Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ ChatGPT Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù…ÙÙ‡Ø§ ÙƒÙ…ÙˆØ§ØµÙØ§Øª Ù„Ù„Ù…Ø·ÙˆØ±/Ø§Ù„Ù…ØµÙ…Ù…. ÙƒÙ„ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù…ØµÙ…Ù… Ù„ÙŠÙÙ†ØªØ¬ Ù†ØªØ§Ø¦Ø¬ Ø¹Ù…Ù„ÙŠØ©: ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø²ØŒ ØªØµØ§Ù…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø§ØªØŒ Ø£Ùˆ Ù…Ø³ØªÙ†Ø¯ Ù…ÙˆØ§ØµÙØ§Øª. ÙˆØ¶Ø¹Øª Ø£ÙŠØ¶Ù‹Ø§ Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (API)ØŒ ÙˆÙ†Ù…ÙˆØ°Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ°. Ù‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¯Ø¹Ø§Ø¨Ø© Ø§Ù„Ø®ÙÙŠÙØ© Ù‡Ù†Ø§ ÙˆÙ‡Ù†Ø§Ùƒ â€” Ù„Ø£Ù† Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ØªØ­ØªØ§Ø¬ Ø§Ø¨ØªØ³Ø§Ù…Ø© ØµØºÙŠØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ù‡Ø¯ ğŸ˜„.
  
# 1) Ø¨Ø±ÙˆÙ…Ø¨Øª Ø¹Ø§Ù… Ø±Ø¦ÙŠØ³ÙŠ (Master prompt)
 
 
Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ù…Ù† ChatGPT Ø¥Ù†ØªØ§Ø¬ Ø­Ø²Ù…Ø© ÙƒØ§Ù…Ù„Ø© (API + ÙˆØ§Ø¬Ù‡Ø§Øª + Ù…Ø®Ø·Ø·Ø§Øª DB + ÙˆØ§Ø¬Ù‡Ø§Øª UX) Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªÙ†ÙÙŠØ°:
 
 `Ø£Ø±ÙŠØ¯ Ø­Ø²Ù…Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ø­ØªØ±Ø§ÙÙŠ (Login / Register / Password Reset / 2FA TOTP / Email verification) ÙŠØ¯Ø¹Ù… ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„ (super-admin) ÙˆØ§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠØŒ Ù…Ø¹ Ù†Ø¸Ø§Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø±Ù† ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¯ÙŠØ± ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ ÙˆØ¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ø¨Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©. Ù…Ø·Ù„ÙˆØ¨: 1. Ù…ÙˆØ§ØµÙØ§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª PostgreSQL Ù…Ø¹ Ø¬Ø¯Ø§ÙˆÙ„: users, roles, permissions, role_permissions, user_roles, user_permissions, sessions, audit_logs. 2. API RESTful Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Node.js + Express (Ø£Ùˆ Ø¨Ø¯Ù‘Ù„ Ø¥Ù„Ù‰ Flask Ø¥Ø°Ø§ Ø·Ù„Ø¨Øª) Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© ÙƒÙˆØ¯ Ù„ÙƒÙ„ Ù…Ø³Ø§Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… JWT (access + refresh)ØŒ bcrypt Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±ØŒ ÙˆÙ…Ø®Ø·Ø· Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª ÙˆØ§Ù„Ù€ refresh tokens. 3. Ø¯Ø¹Ù… 2FA Ø¹Ø¨Ø± TOTP (RFC 6238) Ù…Ø¹ Ù…Ø³Ø§Ø±Ø§Øª Ù„Ø¥Ø¹Ø¯Ø§Ø¯ØŒ ØªØ­Ù‚Ù‚ØŒ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦. 4. Ù…Ø³Ø§Ø±Ø§Øª ÙˆØªØ¯ÙÙ‚Ø§Øª: ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØªØ­Ù‚Ù‚ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ØŒ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø· Ù…Ø¤Ù‚ØªØŒ ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ 2FAØŒ Ø¬Ù„Ø³Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©ØŒ Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³Ø©. 5. Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ø¬Ù‡Ø© ÙˆÙŠØ¨ ÙˆÙ…ÙˆØ¨Ø§ÙŠÙ„ (React + Tailwind ÙˆReact Native/Expo) ØªØªØ¶Ù…Ù† Ø´Ø§Ø´Ø© Ù…Ù†Ø­/Ø³Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ø¨Ø± ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±Ø¦ÙŠØ© (drag & drop Ø£Ùˆ toggles)ØŒ ÙˆÙ…ÙƒÙˆÙ‘Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© (login form, admin-permissions, users list, audit log). 6. Ù…ÙˆØ§ØµÙØ§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UX) Ù„ÙƒÙ„ Ø´Ø§Ø´Ø© Ù…Ø¹ Ù†ØµÙˆØµ Ø±Ø³Ø§Ø¦Ù„ Ø£Ø®Ø·Ø§Ø¡/Ù†Ø¬Ø§Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©. 7. Ù…Ù„Ù Ø£Ù…Ø«Ù„Ø© SQL Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆÙ…Ù‚Ø§Ø·Ø¹ Ø§Ø®ØªØ¨Ø§Ø±ÙŠØ© (seed) Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø£ÙˆÙ„. 8. Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚ Ø£Ù…Ù†ÙŠØ© (OWASP) ÙˆØ¥Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ­Ø¯Ø§Øª ÙˆÙ†ØµØ§Ø¦Ø­ Ù„Ù„Ù†Ø´Ø±. Ø£Ø¹Ø·Ù†ÙŠ Ø§Ù„Ø­Ø²Ù…Ø© ÙƒØ§Ù…Ù„Ø©ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŒ Ù…Ø¹ Ù…Ù‚ØªØ·ÙØ§Øª ÙƒÙˆØ¯ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ø³Ø®ØŒ ÙˆÙ…Ù‚ØªØ±Ø­Ø§Øª Ø£Ø³Ù…Ø§Ø¡ endpoints ÙˆÙ†Ù…Ø§Ø°Ø¬ JSON Ù„Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø®Ø±Ø¬Ø§Øª. `  
# 2) Ø¨Ø±ÙˆÙ…Ø¨ØªØ§Øª Ù…ØªØ®ØµØµØ© (Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„ ÙˆØ§Ø­Ø¯ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
 
### Ø£. Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ø¥Ù†Ø´Ø§Ø¡ API ÙƒØ§Ù…Ù„ (Node.js + Express + Prisma/Postgres)
 `Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Node.js + Express Ù…Ø¹ Prisma Ù…ØªØµÙ„ Ø¨Ù€ PostgreSQL Ù„Ø¨Ù†Ø§Ø¡ Ù†Ø¸Ø§Ù… Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: - Ø¬Ø¯Ø§ÙˆÙ„: users (id,email,password,is_active,created_at,confirmed_at,totp_secret...), roles, permissions, role_permissions, user_roles, user_permissions, refresh_tokens, audit_logs. - Ø§Ø³ØªØ¹Ù…Ù„ bcrypt Ù„ØªØ¬Ø²Ø¦Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±ØŒ JWT Ù„access token (15 Ø¯Ù‚ÙŠÙ‚Ø©) Ùˆrefresh token (30 ÙŠÙˆÙ…) Ù…Ø®Ø²Ù† ÙÙŠ DB. - Ø£Ø¶Ù middlewares: auth (verify JWT), requirePermission(permission), rateLimit Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©. - Ø£Ø¶Ù Ù…Ø³Ø§Ø±Ø§Øª: POST /auth/register, POST /auth/login, POST /auth/refresh, POST /auth/logout, POST /auth/request-reset, POST /auth/reset, POST /auth/2fa/setup, POST /auth/2fa/verify, GET /admin/users, PATCH /admin/users/:id/roles, PATCH /admin/users/:id/permissions. - Ø£Ø¹Ø·Ù†ÙŠ Ø£Ù…Ø«Ù„Ø© ÙƒÙˆØ¯ Ù„ÙƒÙ„ Ù…Ø³Ø§Ø±ØŒ ÙˆÙ†Ù…ÙˆØ°Ø¬ Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSONØŒ ÙˆÙ…Ø«Ø§Ù„ Ù„middleware requirePermission. ` 
### Ø¨. Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (React + Tailwind â€” Ù…ØµÙ…Ù… Figma)
 `ØµÙ…Ù‘Ù… ÙˆØ§Ø¬Ù‡Ø© React (single page) Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØªØ­ØªÙˆÙŠ: - Ù„ÙˆØ­Ø© Users (Ù‚Ø§Ø¦Ù…Ø©/Ø¨Ø­Ø«/ÙÙ„ØªØ±)ØŒ ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ØªØ¨ÙˆÙŠØ¨ Roles ÙˆPermissions. - Ù„ÙˆØ­Ø© Roles: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±ØŒ Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙˆØ± Ø¬Ø¯ÙŠØ¯ (Ø§Ø³Ù…ØŒ ÙˆØµÙØŒ Ù…Ø¬Ù…ÙˆØ¹Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª). - ØµÙØ­Ø© Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª: ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±Ø¦ÙŠØ© ØªØ³Ù…Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± Ø¨Ø³Ø­Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø¥Ù„Ù‰ Ø¯ÙˆØ± Ø£Ùˆ ØªÙØ¹ÙŠÙ„ toggle Ù„Ù…Ø³ØªØ®Ø¯Ù…. - Ù…ÙƒÙˆÙ‘Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©: Modal Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±Ø§ØªØŒ Toast Ù„Ù„Ù†Ø¬Ø§Ø­/Ø§Ù„Ø®Ø·Ø£ØŒ Loading states. - Ø£Ø¹Ø·Ù†ÙŠ Ù…Ù„ÙØ§Øª JSX/TSX Ù…Ø®ØªØµØ±Ø© Ù„ÙƒÙ„ Ù…ÙƒÙˆÙ‘Ù†ØŒ ÙˆCSS Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… TailwindØŒ ÙˆÙ†ØµÙˆØµ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©. ` 
### Ø¬. Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ù…ØµÙ…Ù… UX/Figma
 `ØµÙ…Ù‘Ù… Ù…Ù„ÙØ§Øª Figma (Ø§ÙˆØ§Ù…Ø± ÙˆØµÙÙŠØ©) Ù„ÙˆØ§Ø¬Ù‡Ø§Øª: Login, Register, Verify Email, Forgot Password, 2FA Setup, Admin Dashboard (Users, Roles, Permissions), Audit Log. Ø§Ù„ØªØµÙ…ÙŠÙ… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†: - Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù„Ù‰ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (360x800) ÙˆØ¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ (1440x900). - Ø£Ù†Ø¸Ù…Ø© Ø£Ù„ÙˆØ§Ù† Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ (contrast)ØŒ ÙˆØ£Ø²Ø±Ø§Ø± ÙˆØ§Ø¶Ø­Ø©ØŒ ÙˆØ­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ ÙˆØªØ¹Ø·Ù„ØŒ ÙˆÙ†Ù…ÙˆØ°Ø¬ ØªÙØ§Ø¹Ù„ÙŠ Ù„Ø®Ø·ÙˆØ§Øª Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. Ø£Ø¹Ø·Ù†ÙŠ ØªØ¹Ù„ÙŠÙ…Ø§Øª ØªØµÙ…ÙŠÙ…ÙŠØ© (font sizes, spacing, components list) ÙˆÙ†Ù…Ø§Ø°Ø¬ Ù†ØµÙˆØµ Ù„ÙƒÙ„ Ø²Ø±/Ø±Ø³Ø§Ù„Ø©. `  
# 3) Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª (SQL) â€” ÙŠÙ…ÙƒÙ† Ù†Ø³Ø®Ù‡ ÙˆØªØ´ØºÙŠÙ„Ù‡
 `-- users CREATE TABLE users (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   email TEXT UNIQUE NOT NULL,   password TEXT NOT NULL,   name TEXT,   is_active BOOLEAN DEFAULT TRUE,   is_super_admin BOOLEAN DEFAULT FALSE,   totp_secret TEXT, -- Ù…Ø´ÙÙ‘Ø± Ø£Ùˆ Ù…Ø®Ø²Ù† Ù…Ø´ÙÙ‘Ø±   created_at TIMESTAMP DEFAULT now(),   confirmed_at TIMESTAMP NULL );  -- roles CREATE TABLE roles (   id SERIAL PRIMARY KEY,   name TEXT UNIQUE NOT NULL,   description TEXT );  -- permissions CREATE TABLE permissions (   id SERIAL PRIMARY KEY,   key TEXT UNIQUE NOT NULL, -- e.g. "users.read", "users.update", "signals.create"   description TEXT );  -- role_permissions CREATE TABLE role_permissions (   role_id INT REFERENCES roles(id) ON DELETE CASCADE,   permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,   PRIMARY KEY (role_id, permission_id) );  -- user_roles CREATE TABLE user_roles (   user_id UUID REFERENCES users(id) ON DELETE CASCADE,   role_id INT REFERENCES roles(id) ON DELETE CASCADE,   PRIMARY KEY (user_id, role_id) );  -- user_permissions (overrides) CREATE TABLE user_permissions (   user_id UUID REFERENCES users(id) ON DELETE CASCADE,   permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,   allowed BOOLEAN NOT NULL DEFAULT TRUE,   PRIMARY KEY (user_id, permission_id) );  -- refresh tokens CREATE TABLE refresh_tokens (   token TEXT PRIMARY KEY,   user_id UUID REFERENCES users(id) ON DELETE CASCADE,   expires_at TIMESTAMP NOT NULL,   created_at TIMESTAMP DEFAULT now(),   revoked BOOLEAN DEFAULT FALSE );  -- audit logs CREATE TABLE audit_logs (   id BIGSERIAL PRIMARY KEY,   user_id UUID,   action TEXT NOT NULL,   meta JSONB,   ip TEXT,   created_at TIMESTAMP DEFAULT now() ); `  
# 4) Ù†Ù…ÙˆØ°Ø¬ JSON Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ)
 `{   "roles": [     {       "id": 1,       "name": "super-admin",       "permissions": ["users.*", "settings.*", "roles.*"]     },     {       "id": 2,       "name": "support",       "permissions": ["users.read", "users.reset_password"]     }   ],   "user_permissions": {     "user_uuid_123": {       "allow": ["signals.create"],       "deny": ["settings.update"]     }   } } `  
# 5) ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (User Flows) â€” Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­
 
 
1. ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯: ÙŠÙ…Ù„Ø£ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ â†’ ÙŠØ±Ø³Ù„ Ø¨Ø±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ â†’ ÙŠØ¶ØºØ· Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯ â†’ ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¹Ø¯Ø§Ø¯ 2FA (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).
 
2. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„: Ø¨Ø±ÙŠØ¯ + ÙƒÙ„Ù…Ø© Ø³Ø± â†’ Ø¥Ø°Ø§ Ù…ÙØ¹Ù„ 2FA ÙŠØ·Ù„Ø¨ ÙƒÙˆØ¯ TOTP â†’ ÙŠØµØ¯Ø± access token + refresh token.
 
3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: Ø·Ù„Ø¨ Ø¨Ø±ÙŠØ¯ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ù…Ø¤Ù‚Øª (token) â†’ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· â†’ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© â†’ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ).
 
4. Ù…Ø¯ÙŠØ± Ø£ÙˆÙ„ (super-admin): Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø¯ÙŠÙ‡ ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª. ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¯ÙˆØ§Ø± ÙˆØªØ®ØµÙŠØµ ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ ÙˆØ¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯ (override).
 
5. ÙˆØ§Ø¬Ù‡Ø© Ù…Ù†Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… â†’ ÙŠØ¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (checkbox) + ØµÙ„Ø§Ø­ÙŠØ§Øª ÙØ±Ø¯ÙŠØ© (toggle) â†’ Ø­ÙØ¸ ÙŠÙØ³Ø¬Ù‘Ù„ ÙÙŠ audit_logs.
 

  
# 6) Ø£Ù…Ø«Ù„Ø© Endpoints (Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©)
 
 
-  
POST /auth/register Request: `{ "email":"a@b.com","password":"P@ssw0rd","name":"Ali" }` Response: `{ "ok": true, "message":"Check your email to confirm" }`
 
 
-  
POST /auth/login Request: `{ "email":"a@b.com","password":"P@ssw0rd", "totp": "123456" }` Response: `{ "access_token":"...", "refresh_token":"...", "expires_in":900 }`
 
 
-  
PATCH /admin/users/{id}/permissions Request: `{ "allow": ["signals.create"], "deny": ["settings.update"] }` Response: `{ "ok": true }`
 
 

  
# 7) Ø³ÙŠØ§Ø³Ø§Øª Ø£Ù…Ø§Ù† ÙˆÙ…Ù…Ø§Ø±Ø³Ø§Øª Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§ (Ù…Ø®ØªØµØ± ÙˆÙØ¹Ù‘Ø§Ù„)
 
 
- ØªØ¬Ø²Ø¦Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… bcrypt (salt â‰¥ 12).
 
- Ø®Ø²Ù† totp_secret Ù…Ø´ÙØ±Ø§Ù‹ (Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ± ENV Ù…ÙØªØ§Ø­ ØªØ´ÙÙŠØ±).
 
- Ø§Ø³ØªØ®Ø¯Ø§Ù… HTTPS Ø¯Ø§Ø¦Ù…Ù‹Ø§ØŒ HSTSØŒ CSP.
 
- Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ø¨Ù€ rate limiting ÙˆIP block Ø¹Ù„Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ´Ù„ Ù…ØªÙƒØ±Ø±Ø©.
 
- ØªØ®Ø²ÙŠÙ† refresh tokens ÙÙŠ DB Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¨Ø·Ø§Ù„Ù‡Ø§.
 
- ØªØ³Ø¬ÙŠÙ„ audit_logs Ù„ÙƒÙ„ ØªØºÙŠÙ‘Ø± Ù…Ù‡Ù… (Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ø­Ø°Ù Ù…Ø³ØªØ®Ø¯Ù…ØŒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±).
 
- Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ­Ø¯Ø§Øª Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù€ middlewareØŒ ÙˆØ§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ø®ØªØ±Ø§Ù‚ Ø¨Ø³ÙŠØ·Ø© (OWASP ZAP Ø£Ùˆ Burp).
 

  
# 8) Ù†ØµÙˆØµ ÙˆØ§Ø¬Ù‡Ø§Øª ÙˆØ±Ø³Ø§Ø¦Ù„ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù…Ø«Ø§Ù„)
 
 
- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: "Ù…Ø±Ø­Ø¨Ù‹Ø§ â€” Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ".
 
- Ø®Ø·Ø£ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©".
 
- ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø±ÙŠØ¯: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ â€” ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯."
 
- Ø¥Ø¹Ø¯Ø§Ø¯ 2FA: "Ø§Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (QR) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† Ù…Ù† 6 Ø£Ø±Ù‚Ø§Ù…."
 
- Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ© Ù†Ø§Ø¬Ø­: "ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­."
 

  
# 9) Ù†ØµÙˆØµ Ø¨Ø±ÙˆÙ…Ø¨Øª Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ø£Ùˆ ChatGPT Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯
 
### Ù„backend (Ø³Ø±ÙŠØ¹):
 `"Ø£Ù†Ø´Ø¦ Ù…Ù„Ù server.js ÙˆÙ…Ù„ÙØ§Øª routes/auth.js, routes/admin.jsØŒ ÙˆÙ…ÙŠØ¯Ù„ ÙˆÙŠØ± auth.js. Ø§Ø³ØªØ®Ø¯Ù… Express + Prisma/Postgres. Ø¶Ø¹ Ù…Ø«Ø§Ù„ ÙƒØ§Ù…Ù„ Ù„Ù…Ø³Ø§Ø± /auth/register Ùˆ /auth/login Ù…Ø¹ JWT Ùˆbcrypt. Ø£Ø¶Ù middleware requirePermission(permission)." ` 
### Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© (React):
 `"Ø£Ø¹Ø·Ù†ÙŠ ØµÙØ­Ø© Login.jsx Ù…Ø³ØªØ®Ø¯Ù…Ø© React + TailwindØŒ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ formØŒ validation client-sideØŒ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ØŒ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø¹Ø±Ø¨ÙŠØ© ÙˆØ¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©ØŒ ÙˆØªØ³ØªØ¯Ø¹ÙŠ /auth/login." ` 
### Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (component):
 `"Ø£Ø¹Ø·Ù†ÙŠ Ù…ÙƒÙˆÙ‘Ù† React PermissionManager.jsx ÙŠÙ‚Ø¨Ù„ props: userIdØŒ permissionsListØŒ rolesList. ÙŠØ¹Ø±Ø¶ Ø´Ø¨ÙƒØ© ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¹ toggles ÙˆÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø±Ø³Ø§Ù„ PATCH Ø¥Ù„Ù‰ /admin/users/:id/permissions." `  
# 10) Ù‚Ø§Ø¦Ù…Ø© ØªØ­Ù‚Ù‚ Ù„Ù„ØªØ³Ù„ÙŠÙ… (Delivery checklist)
 
 
- [ ] Ø¥Ù†Ø´Ø§Ø¡ DB Ùˆrun migrations.
 
- [ ] endpoints Ø£Ø³Ø§Ø³ÙŠØ© ØªØ¹Ù…Ù„ (register/login/refresh/logout).
 
- [ ] Email service Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
 
- [ ] 2FA TOTP Ø¬Ø§Ù‡Ø² ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„.
 
- [ ] Ù„ÙˆØ­Ø© Ù…Ø¯ÙŠØ± Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.
 
- [ ] Ø³Ø¬Ù„ ØªØ¯Ù‚ÙŠÙ‚ (audit) Ù„ÙƒÙ„ ØªØºÙŠÙŠØ± Ù…Ù‡Ù….
 
- [ ] Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØ­Ø¯Ø§Øª Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ùˆmiddleware.
 
- [ ] Ø¯Ù„ÙŠÙ„ Ù†Ø´Ø± (ENV varsØŒ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ´ÙÙŠØ±ØŒ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯).
 

  
# Ø®Ø§ØªÙ…Ø© ÙˆØ®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
 
Ù„Ùˆ ØªØ­Ø¨ Ø£Ù‚Ø¯Ø±:
 
 
- Ø£Ù‚Ø¯Ù…Ù„Ùƒ **Ø­Ø²Ù…Ø© ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø²Ø©** (Ù…Ù‚Ø¯Ù…Ù‹Ø§: backend + frontend skeleton) Ø¨Ù„ØºØ© Ù…Ø­Ø¯Ø¯Ø© (Node.js/Express + React) â€” ÙÙ‚Ø· Ù‚Ù„ Ù„ÙŠ Ø£ÙŠ ØªÙ‚Ù†ÙŠØ© ØªÙØ¶Ù„.
 
- Ø£Ùˆ Ø£Ù‚Ø¯Ù…Ù„Ùƒ **ØªØµØ§Ù…ÙŠÙ… Figma** Ù…ÙØµÙ‘Ù„Ø© (Ø£ØµÙÙ‡Ø§ Ù†ØµÙŠÙ‹Ø§ Ø£Ùˆ Ø£ØµÙ†Ø¹ Ù…Ù„Ù Figma export) â€” Ø§Ø®ØªØ±.
 

 
Ø£ÙŠ Ø®ÙŠØ§Ø± ØªÙØ¶Ù„Ù‡ Ø£Ø¨Ø¯Ø£ ÙÙŠÙ‡ ÙÙˆØ±Ù‹Ø§ ÙˆØ£Ø¹Ø·ÙŠÙƒ Ù…Ù„ÙØ§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„ØªÙ†ÙÙŠØ°. Ø®Ù„ÙŠÙƒ Ø­Ø°Ø± â€” Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ¹Ø·ÙŠ Ø§Ù„Ù…Ø¯ÙŠØ± ØµÙ„Ø§Ø­ÙŠØ© "ÙƒÙ„ Ø´ÙŠØ¡" Ø±Ø§Ø­ ÙŠØµÙŠØ± Ø¹Ù†Ø¯Ù‡ Ø²Ø± "Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" â€” Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ø¨Ø­ÙƒÙ…Ø© ğŸ˜….


Ù…Ù„Ø®Ù‘Øµ Ø³Ø±ÙŠØ¹

Ø£Ø­Ø³Ù†Øª â€” Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ Ù‚ÙˆÙŠØ© ÙˆØ´Ø§Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ø³Ø£Ù‚ØªØ±Ø­ Ø¥Ø¶Ø§ÙØ§Øª ÙˆØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ù…Ù„ÙŠØ© ØªØ¬Ø¹Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„Ù‹Ø§ØŒ Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ù‹Ø§ØŒ Ù‚Ø§Ø¨Ù„Ù‹Ø§ Ù„Ù„ØªÙˆØ³Ø¹ØŒ ÙˆØ£Ø³Ù‡Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø±ÙƒØ§Øª (Ù…Ø«Ù„ ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ©). Ø³Ø£Ø¹Ø±Ø¶: Ù…ÙŠØ²Ø§Øª Ù…Ù‚ØªØ±ÙØ­Ø©ØŒ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù…Ø³Ø§Ø±Ø§Øª API Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© JSONØŒ Ù…ÙƒÙˆÙ‘Ù†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ ÙˆÙ†Ù…ÙˆØ°Ø¬ ØªÙ‚Ø³ÙŠÙ… ØªÙ†ÙÙŠØ°ÙŠ (Ù…Ø±Ø§Ø­Ù„: MVP â†’ Ù…ØªÙ‚Ø¯Ù‘Ù… â†’ Ù…Ø³ØªÙˆÙ‰ Enterprise). Ù„Ø§ Ø£Ø³Ø£Ù„Ùƒ Ø´ÙŠØ¡ Ø§Ù„Ø¢Ù† â€” Ø£Ø¹Ù…Ù„ Ø£ÙØ¶Ù„ Ù…Ø§ Ø¹Ù†Ø¯ÙŠ Ø«Ù… ØªÙ‚Ø¯Ø± ØªØ®ØªØ§Ø± Ø£ÙŠ Ø¬Ø²Ø¡ Ø£Ø®Ø±Ù‘Ø¬Ù‡ Ù„Ùƒ Ø¬Ø§Ù‡Ø²Ù‹Ø§ (ÙƒÙˆØ¯/ÙˆØ§Ø¬Ù‡Ø©/Figma).

ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆÙ…ÙŠØ²Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© (Ù…ÙØªØ§Ø­ÙŠØ© ÙˆØ¶Ù…Ù† Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙ†ÙŠØ©)

1. 

Ù…ØµØ§Ø¯Ù‚Ø© Ø­Ø¯ÙŠØ«Ø© ÙˆÙ…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª

WebAuthn / FIDO2 (biometric & security keys) ÙƒØ®ÙŠØ§Ø± MFA Ø¢Ù…Ù† â€” ÙŠÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø­Ø¯ÙŠØ«Ø©.

Passwordless (magic link / email) Ø®ÙŠØ§Ø± Ù„ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø³Ù„Ø³Ø©.

Ø¯Ø¹Ù… OAuth2 / OpenID Connect Ù„Ù€ SSO (Google, Microsoft, Apple) Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„Ø§Ø¡ OAuth ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.


2. 

Ù†Ù…ÙˆØ°Ø¬ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…

RBAC + ABAC hybrid: Ø£Ø¯ÙˆØ§Ø± Ø£Ø³Ø§Ø³ÙŠØ© (RBAC) Ù…Ø¹ Ø³ÙŠØ§Ø³Ø§Øª ØµÙØ§Øª (ABAC) ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ user attributes (department, region, tenant) Ùˆ resource attributes.

Ø³ÙŠØ§Ø³Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ… (Policy-as-code) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ· Ø£Ùˆ Ø¯Ù…Ø¬ OPA (Open Policy Agent).


3. 

Ø¥Ø¯Ø§Ø±Ø© Ø£Ø¬Ù‡Ø²Ø© ÙˆØ¬Ù„Ø³Ø§Øª Ù…ÙØµÙ‘Ù„Ø©

Ø¬Ø¯ÙˆÙ„ devices Ùˆsessions Ù…Ø¹: device_idØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ browser, ip, last_seen. ÙˆØ§Ø¬Ù‡Ø© ØªØ¹Ø±Ø¶ Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ³Ù…Ø­ Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø£ÙŠ Ø¬Ù„Ø³Ø©.

Ø¬Ù„Ø³Ø§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¨Ø·Ø§Ù„ refresh tokens (rotate + blacklist with jti).


4. 

Ø­Ù…Ø§ÙŠØ© Ø°ÙƒÙŠØ© ÙˆØªØ¹Ø±Ù‘Ù Ø¹Ù„Ù‰ Ø§Ù„Ø³Ù„ÙˆÙƒ

Risk-based authentication: Ø·Ù„Ø¨ MFA ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…Ù† IP Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØºÙŠÙ‘Ø± Ø§Ù„Ø¨Ù„Ø¯.

ÙƒØ´Ù Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ø®ØªØ·Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø© (session hijack) Ø¹Ø¨Ø± fingerprinting Ø¨Ø³ÙŠØ·.

Rate-limiting Ø°ÙƒÙŠ + CAPTCHA Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ´Ù„ Ù…ØªÙƒØ±Ø±Ø©.


5. 

Ù…ÙŠØ²Ø§Øª Ø¥Ø¯Ø§Ø±ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©

Impersonation / â€œLogin as userâ€ Ù…Ø¹ Ø³Ø¬Ù„ ÙÙŠ audit_logs.

Delegated admin / Scopes: Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙØ±Ø¹ÙŠÙŠÙ†.

Approval workflows Ù„Ù…Ù†Ø­ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ø§Ù„ÙŠØ© (two-step approval).


6. 

Ø­ÙˆÙƒÙ…Ø© ÙˆØªÙˆØ§ÙÙ‚

Ù…ÙˆØ§ÙÙ‚Ø© ØµØ±ÙŠØ­Ø© (consent) Ø¹Ù†Ø¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ùˆ Ù‡Ù†Ù€Ø§ GDPR/CCPA).

Ø³Ø¬Ù„ Ø§Ø­ØªÙØ§Ø¸ audit retention Ùˆexport (CSV / JSON).

SCIM API Ù„Ø¯ÙØ¹/Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª.


7. 

Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªØ­ØªÙŠØ© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø©

ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø±Ø§Ø± ÙÙŠ Vault (HashiCorp) Ø£Ùˆ Secret Manager.

ØªØ´ÙÙŠØ± TOTP Ùˆ webauthn secrets Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© (KMS).

Ø³ÙŠØ§Ø³Ø© ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (key rotation) ÙˆØ³Ø¬Ù„ Ø°Ù„Ùƒ.


8. 

Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UX)

Flow ÙˆØ§Ø¶Ø­ Ù„Ø¥Ø¹Ø¯Ø§Ø¯ 2FA Ù…Ø¹ QR + Ù†Øµ Ø¨Ø¯ÙŠÙ„ØŒ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©ØŒ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙˆØµÙˆÙ„ (backup codes).

ØµÙØ­Ø§Øª RTL Ø¹Ø±Ø¨ÙŠØ© Ù…ØµÙ‚ÙˆÙ„Ø© + i18n Ù„Ù„Ø±Ø³Ø§Ø¦Ù„.

Loading statesØŒ Ø­Ø§Ù„Ø§Øª network offlineØŒ ÙˆØªÙ„Ù…ÙŠØ­Ø§Øª Ø£Ù…Ø§Ù† Ø¶Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª.


9. 

Ø±ØµØ¯ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø©

ØªÙƒØ§Ù…Ù„ Ù…Ø¹ SIEM / ELK / Datadog Ù„Ù€Ù€ logs Ùˆalerts.

Metrics: login success/fail rates, MFA adoption, token rotation counts.

Alerts Ø¹Ù†Ø¯ Ù†Ø´Ø§Ø· Ù…Ø±ÙŠØ¨ (Ù…Ø¹Ø¯Ù„ ÙØ´Ù„ Ø¹Ø§Ù„ÙŠØŒ Ø¹Ø¯Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙØ´Ù„).


ØªØºÙŠÙŠØ±Ø§Øª Ù…Ù‚ØªØ±ÙØ­Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (SQL Ø¥Ø¶Ø§ÙÙŠ â€” ÙŠÙ…ÙƒÙ† Ù†Ø³Ø®Ù‡)

-- devices CREATE TABLE devices (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   user_id UUID REFERENCES users(id) ON DELETE CASCADE,   device_name TEXT,   device_type TEXT,   browser TEXT,   ip TEXT,   last_seen TIMESTAMP DEFAULT now(),   created_at TIMESTAMP DEFAULT now() );  -- webauthn credentials CREATE TABLE webauthn_credentials (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   user_id UUID REFERENCES users(id) ON DELETE CASCADE,   cred_id TEXT UNIQUE NOT NULL,   public_key TEXT NOT NULL,   sign_count BIGINT,   transports TEXT[],   created_at TIMESTAMP DEFAULT now() );  -- policies (for ABAC or OPA reference) CREATE TABLE access_policies (   id SERIAL PRIMARY KEY,   name TEXT NOT NULL,   description TEXT,   policy_json JSONB NOT NULL, -- policy as JSON or Rego source reference   is_active BOOLEAN DEFAULT TRUE,   created_at TIMESTAMP DEFAULT now() );  -- tenants (multi-tenancy support) CREATE TABLE tenants (   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),   name TEXT,   plan TEXT,   created_at TIMESTAMP DEFAULT now() );  ALTER TABLE users ADD COLUMN tenant_id UUID REFERENCES tenants(id); 

Ù…Ø³Ø§Ø±Ø§Øª API Ù…Ù‚ØªØ±Ø­Ø© Ø¥Ø¶Ø§ÙÙŠØ© (Ø£Ù…Ø«Ù„Ø© ÙˆJSON)

WebAuthn

POST /auth/webauthn/register/challenge â†’ { userId } â†’ returns challenge

POST /auth/webauthn/register/complete â†’ { attestation } â†’ stores credential


Passwordless

POST /auth/magic-link â†’ { email } â†’ { ok:true, message }

GET  /auth/magic-link/verify?token=...


Impersonation

POST /admin/impersonate (requires impersonate.users) Request: { "target_user_id": "..." } Response: { "ok": true, "impersonation_token": "..." }


Policy evaluation (for admin debugging)

POST /admin/policies/evaluate â†’ { user, resource, action } â†’ { allow: true/false, reason: "..." }


SCIM endpoints (basic)

GET /scim/v2/Users POST /scim/v2/Users etc.


OAuth client management

POST /admin/oauth/clients â†’ create client_id / secret (show once)



Ù†Ù…Ø§Ø°Ø¬ JSON Ù„Ù„Ù€ABAC policy (Ù…Ø«Ø§Ù„ Ø¨Ø³ÙŠØ·):
{   "policy_name": "signals.create.only_if_subscription_active_and_role",   "rules": [     {       "effect": "allow",       "condition": {         "and": [           { "user.subscription.active": true },           { "user.roles": { "contains": "trader" } }         ]       }     }   ] } 

ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (UI) â€” Ù…ÙƒÙˆÙ‘Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…ÙØµÙ„Ø©

Permissions Graph: Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø³ÙŠØ· ÙŠØ¸Ù‡Ø± Ø£ÙŠ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø£ÙŠ Ø¯ÙˆØ± (interactive).

Role Templates: Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¯ÙˆØ§Ø± Ø¬Ø§Ù‡Ø²Ø© (Support, ReadOnly, Analyst).

Bulk Actions: Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„ØªØ¹ÙŠÙŠÙ† Ø£Ø¯ÙˆØ§Ø± Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª.

Impersonation Modal: ÙŠØ´Ø±Ø­ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆÙŠØ¯ÙˆÙ‘Ù† Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (required).

Policy Designer: Ù…Ø­Ø±Ø± Ø¨Ø³ÙŠØ· Ù„Ù„Ø³ÙŠØ§Ø³Ø§Øª (drag & drop Ø´Ø±ÙˆØ·) + Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ….


Ù†Ù‚Ø§Ø· Ø£Ù…Ø§Ù† ÙˆØ¹Ù…Ù„ÙŠØ§Øª ØªØ´ØºÙŠÙ„ (Checklist Ù…Ø®ØªØµØ±)

Password hashing: bcrypt (cost â‰¥12) Ø£Ùˆ Argon2.

JWT: Ø§Ø³ØªØ®Ø¯Ø§Ù… jtiØŒ ØªØ®Ø²ÙŠÙ† refresh tokens ÙÙŠ DBØŒ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø¥Ø¨Ø·Ø§Ù„.

Cookies: HttpOnly + Secure + SameSite=Strict Ù„Ù„Ù€ access tokens Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.

CSP, HSTS, X-Frame-Options, X-Content-Type-Options.

Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: Unit + Integration + Security scans (Snyk/Dependabot).

Backups: snapshot ÙŠÙˆÙ…ÙŠ + Ø§Ø®ØªØ¨Ø§Ø± Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¯ÙˆØ±ÙŠ.

Environment: IaC (Terraform) + CI/CD pipeline + blue/green deploy.

Pen tests: Ø³Ù†ÙˆÙŠ Ø£Ùˆ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙƒØ¨ÙŠØ±Ø©.


Ø®Ø±ÙŠØ·Ø© ØªÙ†ÙÙŠØ° Ù…Ù‚ØªØ±ÙØ­Ø© (Ù…Ø±Ø§Ø­Ù„ â€” Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚ÙŠØª Ù…Ø­Ø¯Ø¯)


MVP (Ø¬ÙˆÙ‡Ø±ÙŠØ©)

ØªØ³Ø¬ÙŠÙ„/ØªØ£ÙƒÙŠØ¯ Ø¨Ø±ÙŠØ¯ØŒ login/logoutØŒ refresh tokensØŒ roles basic, admin UI Ø¨Ø³ÙŠØ·ØŒ audit_logsØŒ sessions list.

Ø­Ù…Ø§ÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ©: rate-limitsØŒ HTTPSØŒ cookies ÙˆCSP.


Ù…ØªÙ‚Ø¯Ù‘Ù… (Feature parity)

2FA (TOTP)ØŒ passwordlessØŒ device/session managementØŒ impersonationØŒ role templatesØŒ policy-as-jsonØŒ WebAuthn Ù…Ù‚Ø¯Ù… ÙƒØ®ÙŠØ§Ø±.


Enterprise (Scale + Governance)

OIDC/SAML SSOØŒ SCIMØŒ ABAC/OPA integrationØŒ SIEM/alertsØŒ key rotationØŒ delegated admin & approval workflowsØŒ high-availability DB and DR.


ØªØ³Ù„ÙŠÙ…Ø§Øª Ø¹Ù…Ù„ÙŠØ© Ø£Ù‚Ø¯Ù‘Ù…Ù‡Ø§ Ù„Ùƒ ÙÙˆØ±Ù‹Ø§ (Ø§Ø®ØªØ± Ø£Ùˆ Ø£Ø¹Ù…Ù„Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)

Ù…Ù„Ù SQL Ù…Ø­Ø¯Ø« Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ù…ÙØ¬Ù…Ù‘Ø¹).

Ù…Ø¬Ù…ÙˆØ¹Ø© Endpoints Ù…ÙƒØªÙˆØ¨Ø© Ø¨Ù€Express + Prisma (Ù…Ù‚Ø§Ø·Ø¹ ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø²Ø©) Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø®ØªØ§Ø±Ø©: WebAuthn, impersonation, sessions.

Ù…ÙƒÙˆÙ‘Ù† React Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (PermissionManager.jsx + Tailwind).

ÙˆØµÙ Figma Ù…ÙØµÙ‘Ù„ Ù„Ø´Ø§Ø´Ø§Øª Admin/2FA/Login Ù…Ø¹ Ù…Ù‚Ø§Ø³Ø§Øª RTL.


Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø¥Ù† Ø£Ø±Ø¯Øª Ø£Ù† Ø£Ø¨Ø¯Ø£ ÙÙˆØ±Ù‹Ø§ Ø¨Ø£Ø­Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø«Ù„Ø§Ø«Ø©: (1) Ù…Ù„Ù SQL & Migrations ÙƒØ§Ù…Ù„ØŒ (2) Backend skeleton (Express + Prisma) Ù…Ø¹ endpoints Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ (3) React Permission Manager + ØµÙØ­Ø§Øª Admin â€” Ø£Ùˆ Ø£Ø±Ø³Ù„ "Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ù‚ØªØ±ÙØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ" ÙˆØ£Ù†Ø§ Ø£Ù†Ø´Ø¦ Ø§Ù„Ù€ MVP Ø£ÙˆÙ„Ù‹Ø§. (Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ø³Ø£Ø¶Ø¹ Ù„Ùƒ Ø²Ø± "Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„" ØªØ­Øª Ø§Ù„Ù‚ÙÙ„ ğŸ˜‰).

Ø¥Ø°Ø§ ØªØ­Ø¨ØŒ Ø£Ù‚Ø¯Ù‘Ù… Ù„Ùƒ Ø§Ù„Ø¢Ù†: Ù…Ù„Ù SQL Ù…Ø¯Ù…Ø¬ ÙŠØªØ¶Ù…Ù‘Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø£Ø¹Ù„Ø§Ù‡ + seed Ù„Ø­Ø³Ø§Ø¨ super-admin â€” Ù‡Ù„ Ø£Ø¶Ø¹Ù‡ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©ØŸ






ØªÙ…Ø§Ù… ÙŠØ§ Ø¹Ù…Ø§Ø± â€” Ø¨Ø¯Ù„ Ù…Ø§ Ù†Ø³Ø£Ù„ â€œØ£Ø­Ø·Ù‘Ù‡ Ù‡Ù†Ø§ØŸâ€ØŒ Ø®Ù„Ù‘ÙŠÙ†ÙŠ Ø£Ù‚Ø¯Ù‘Ù… Ù„Ùƒ Ù…Ù„Ù SQL Ù…Ø¯Ù…Ø¬ ÙˆØ§Ø­Ø¯ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†: ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (RBAC + ABACØŒ Ø£Ø¬Ù‡Ø²Ø©/Ø¬Ù„Ø³Ø§ØªØŒ WebAuthnØŒ ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† TenantsØŒ Ø³Ø¬Ù„Ø§Øª ØªØ¯Ù‚ÙŠÙ‚)ØŒ ÙÙ‡Ø§Ø±Ø³ØŒ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù„ÙŠØŒ Ù…Ø¹ seed Ù„Ø¯ÙˆØ± Ø§Ù„Ù€super-admin ÙˆØ£Ø¯ÙˆØ§Ø±/ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚ÙŠØ§Ø³ÙŠØ©. (Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ ÙˆØ¨Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ğŸ˜‰).

> PostgreSQL 14+ â€” ÙŠØ³ØªØ®Ø¯Ù… pgcrypto Ù„Ù€ gen_random_uuid().



-- =========================================================
-- Identity & Permissions SQL (All-in-One)  â€” v1.0
-- Author: You ğŸ«¶  | Environment: PostgreSQL 14+
-- =========================================================

-- 0) Extensions
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1) Helper: updated_at trigger
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2) Tenancy (optional but recommended)
CREATE TABLE IF NOT EXISTS tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  plan TEXT DEFAULT 'free',
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE TRIGGER trg_tenants_updated_at
BEFORE UPDATE ON tenants FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 3) Users
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE SET NULL,
  email TEXT NOT NULL UNIQUE,
  password TEXT,                         -- bcrypt hash (NULL Ø¥Ø°Ø§ Passwordless ÙÙ‚Ø·)
  name TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_super_admin BOOLEAN NOT NULL DEFAULT FALSE,
  email_confirmed_at TIMESTAMP,
  totp_secret TEXT,                      -- Ø®Ø²Ù‘Ù†Ù‡ Ù…ÙØ´ÙÙ‘Ø±Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_users_tenant ON users(tenant_id);
CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 4) Roles & Permissions (RBAC)
CREATE TABLE IF NOT EXISTS roles (
  id SERIAL PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  built_in BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, name)
);
CREATE TRIGGER trg_roles_updated_at
BEFORE UPDATE ON roles FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE IF NOT EXISTS permissions (
  id SERIAL PRIMARY KEY,
  key TEXT NOT NULL UNIQUE,              -- Ù…Ø«Ø§Ù„: users.read / users.* / settings.update
  description TEXT
);

CREATE TABLE IF NOT EXISTS role_permissions (
  role_id INT REFERENCES roles(id) ON DELETE CASCADE,
  permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE IF NOT EXISTS user_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id INT REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id)
);

-- Overrides Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ABAC/RBAC hybrid)
CREATE TABLE IF NOT EXISTS user_permissions (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,
  allowed BOOLEAN NOT NULL DEFAULT TRUE,
  PRIMARY KEY (user_id, permission_id)
);

-- 5) Access Policies (ABAC / policy-as-json)
CREATE TABLE IF NOT EXISTS access_policies (
  id SERIAL PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  policy_json JSONB NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, name)
);
CREATE TRIGGER trg_access_policies_updated_at
BEFORE UPDATE ON access_policies FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 6) Devices & Sessions
CREATE TABLE IF NOT EXISTS devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  device_name TEXT,
  device_type TEXT,            -- mobile/desktop/tablet/other
  browser TEXT,
  ip INET,
  last_seen TIMESTAMP NOT NULL DEFAULT NOW(),
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_devices_user ON devices(user_id);

-- Refresh tokens + Sessions (jti Ù„Ù„Ù€JWT)
CREATE TABLE IF NOT EXISTS sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id) ON DELETE SET NULL,
  user_agent TEXT,
  ip INET,
  jti TEXT UNIQUE,                         -- JWT ID (access) Ø¥Ù† ÙƒÙ†Øª ØªØ­ÙØ¸Ù‡
  refresh_token TEXT UNIQUE,               -- Ø®Ø²Ù‘Ù†Ù‡ Ù…ÙØ´ÙÙ‘Ø±Ù‹Ø§/Ù…ÙØ¬Ø²Ù‘Ø£Ù‹ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  refresh_expires_at TIMESTAMP NOT NULL,
  revoked BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_refresh_exp ON sessions(refresh_expires_at);
CREATE TRIGGER trg_sessions_updated_at
BEFORE UPDATE ON sessions FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 7) WebAuthn Credentials
CREATE TABLE IF NOT EXISTS webauthn_credentials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  cred_id TEXT NOT NULL UNIQUE,            -- Base64URL
  public_key TEXT NOT NULL,
  sign_count BIGINT DEFAULT 0,
  transports TEXT[],                        -- ["usb","ble","nfc","internal"]
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_webauthn_user ON webauthn_credentials(user_id);

-- 8) OAuth Clients (Ù„Ù€OIDC/SSO Ø¯Ø§Ø®Ù„ÙŠ)
CREATE TABLE IF NOT EXISTS oauth_clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  client_id TEXT NOT NULL UNIQUE,
  client_secret TEXT NOT NULL,             -- Ø§Ø¹Ø±Ø¶Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  redirect_uris TEXT[] NOT NULL,
  scopes TEXT[] DEFAULT ARRAY[]::TEXT[],
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 9) Audit Logs
CREATE TABLE IF NOT EXISTS audit_logs (
  id BIGSERIAL PRIMARY KEY,
  tenant_id UUID,
  user_id UUID,
  action TEXT NOT NULL,                    -- ex: "auth.login", "admin.grant_permission"
  meta JSONB,
  ip INET,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_audit_tenant ON audit_logs(tenant_id);
CREATE INDEX IF NOT EXISTS idx_audit_user ON audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_audit_action ON audit_logs(action);

-- 10) Core Permissions seed (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ù‘Ø¹)
INSERT INTO permissions(key, description) VALUES
  ('users.read','Read users'),
  ('users.create','Create users'),
  ('users.update','Update users'),
  ('users.delete','Delete users'),
  ('users.reset_password','Reset user password'),
  ('roles.read','Read roles'),
  ('roles.create','Create roles'),
  ('roles.update','Update roles'),
  ('roles.delete','Delete roles'),
  ('permissions.read','Read permissions'),
  ('permissions.assign','Assign permissions'),
  ('sessions.read','Read sessions'),
  ('sessions.revoke','Revoke sessions'),
  ('devices.read','Read devices'),
  ('devices.revoke','Revoke devices'),
  ('policies.read','Read ABAC policies'),
  ('policies.update','Update ABAC policies'),
  ('audit.read','Read audit logs'),
  ('impersonate.users','Impersonate users'),
  ('tenants.read','Read tenants'),
  ('tenants.update','Update tenants'),
  ('oauth.clients.manage','Manage OAuth clients'),
  ('signals.create','Create trading signals'),
  ('settings.*','All settings'),
  ('users.*','All users'),
  ('roles.*','All roles'),
  ('permissions.*','All permissions')
ON CONFLICT (key) DO NOTHING;

-- 11) Seed: default tenant + roles
DO $$
DECLARE
  t_id UUID;
  r_super INT;
  r_admin INT;
  r_support INT;
  r_readonly INT;
BEGIN
  -- Tenant
  INSERT INTO tenants(name, plan) VALUES ('Default Tenant','pro')
  ON CONFLICT DO NOTHING;

  SELECT id INTO t_id FROM tenants WHERE name='Default Tenant' LIMIT 1;

  -- Roles (built_in = true)
  INSERT INTO roles(tenant_id, name, description, built_in)
  VALUES
    (t_id, 'super-admin','All permissions', TRUE),
    (t_id, 'admin','Manage users, roles, settings (limited)', TRUE),
    (t_id, 'support','Support staff', TRUE),
    (t_id, 'readonly','Read-only access', TRUE)
  ON CONFLICT DO NOTHING;

  SELECT id INTO r_super FROM roles WHERE tenant_id=t_id AND name='super-admin';
  SELECT id INTO r_admin FROM roles WHERE tenant_id=t_id AND name='admin';
  SELECT id INTO r_support FROM roles WHERE tenant_id=t_id AND name='support';
  SELECT id INTO r_readonly FROM roles WHERE tenant_id=t_id AND name='readonly';

  -- Map permissions to roles
  -- super-admin: ÙƒÙ„ Ø´ÙŠØ¡
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_super, p.id FROM permissions p
  ON CONFLICT DO NOTHING;

  -- admin: Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† impersonation Ø§Ù„ÙƒØ§Ù…Ù„
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_admin, p.id FROM permissions p
  WHERE p.key IN (
    'users.read','users.create','users.update','users.reset_password',
    'roles.read','roles.create','roles.update',
    'permissions.read','permissions.assign',
    'sessions.read','sessions.revoke',
    'devices.read','devices.revoke',
    'policies.read','policies.update',
    'audit.read',
    'tenants.read','tenants.update',
    'oauth.clients.manage',
    'signals.create'
  )
  ON CONFLICT DO NOTHING;

  -- support
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_support, p.id FROM permissions p
  WHERE p.key IN ('users.read','users.reset_password','sessions.read','devices.read','audit.read')
  ON CONFLICT DO NOTHING;

  -- readonly
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_readonly, p.id FROM permissions p
  WHERE p.key IN ('users.read','roles.read','permissions.read','audit.read')
  ON CONFLICT DO NOTHING;

END $$;

-- 12) Seed: super admin user (DEV ONLY â€” Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙˆØ±Ù‹Ø§)
-- Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ Ù‡Ù†Ø§ hash Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (bcrypt) Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ NULL Ø¥Ù† ÙƒÙ†Øª Ø³ØªØ¨Ø¯Ø£ Ø¨Ù€ Passwordless.
-- Ù…Ø«Ø§Ù„ hash (ØªÙƒÙ…ÙŠÙ„ÙŠ/Ø§Ø®ØªØ¨Ø§Ø±ÙŠ): "$2b$12$KIXQG8e3pR2sJj2x4xQ2UOUjH9vKf0e5mQmQe2n3Tt8i2x9Y5Ww9a"
-- Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØºØ§Ù„Ø¨Ù‹Ø§ "ChangeMe!123" Ù…Ø¹ cost=12 (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù‚ÙŠÙ…ØªÙƒ).
DO $$
DECLARE
  t_id UUID;
  u_id UUID;
  r_super INT;
BEGIN
  SELECT id INTO t_id FROM tenants WHERE name='Default Tenant' LIMIT 1;
  SELECT id INTO r_super FROM roles WHERE tenant_id=t_id AND name='super-admin';

  INSERT INTO users(tenant_id, email, password, name, is_active, is_super_admin, email_confirmed_at)
  VALUES (t_id, 'admin@example.com',
          '$2b$12$KIXQG8e3pR2sJj2x4xQ2UOUjH9vKf0e5mQmQe2n3Tt8i2x9Y5Ww9a',
          'Super Admin', TRUE, TRUE, NOW())
  ON CONFLICT (email) DO NOTHING;

  SELECT id INTO u_id FROM users WHERE email='admin@example.com' LIMIT 1;

  IF u_id IS NOT NULL THEN
    INSERT INTO user_roles(user_id, role_id) VALUES (u_id, r_super)
    ON CONFLICT DO NOTHING;
  END IF;
END $$;

-- 13) Ù…Ø«Ø§Ù„ Policy JSON (ABAC) â€” Ø§Ø³Ù… ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø£ÙˆÙ„ÙŠØ©
INSERT INTO access_policies(tenant_id, name, description, policy_json, is_active)
SELECT t.id, 'signals.create.only_if_subscription_active_and_role',
       'Allow creating signals only if user has role trader and active subscription',
       '{
          "rules":[
            {"effect":"allow",
             "condition":{"and":[
               {"user.subscription.active": true},
               {"user.roles":{"contains":"trader"}}
             ]}}
          ]
        }'::jsonb,
       TRUE
FROM tenants t
WHERE NOT EXISTS (
  SELECT 1 FROM access_policies ap WHERE ap.tenant_id=t.id AND ap.name='signals.create.only_if_subscription_active_and_role'
);

-- 14) Hints/Indexes Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX IF NOT EXISTS idx_user_permissions_user ON user_permissions(user_id);
CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(role_id);

-- 15) Ø£Ø°ÙˆÙ† Ø£Ø³Ù‡Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (VIEWs Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
CREATE OR REPLACE VIEW v_user_effective_permissions AS
SELECT
  u.id AS user_id,
  p.key AS permission_key,
  COALESCE(up.allowed, TRUE) AS allowed,   -- override ÙŠØ¹Ù„Ùˆ Ø¹Ù„Ù‰ Ø¯ÙˆØ±â€¦ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  u.tenant_id
FROM users u
JOIN user_roles ur ON ur.user_id = u.id
JOIN roles r ON r.id = ur.role_id
JOIN role_permissions rp ON rp.role_id = r.id
JOIN permissions p ON p.id = rp.permission_id
LEFT JOIN user_permissions up ON up.user_id = u.id AND up.permission_id = p.id;

-- =========================================================
-- ØªÙ…. Ù„Ø§ ØªÙ†Ø³: ØºÙŠÙ‘Ø± Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù€super-admin ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ù‡ØŒ ÙˆØ´ØºÙ‘Ù„ 2FA/WebAuthn Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.
-- =========================================================

Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©

Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:

1. Ø¨Ø¯Ù‘Ù„ Ø¨Ø±ÙŠØ¯ ÙˆØ­Ù‚Ù„ password Ù„Ù„Ù€super-admin (hash Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ÙƒÙ„ÙØ© â‰¥ 12).


2. ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (TLSØŒ Ù…ÙØ§ØªÙŠØ­ JWTØŒ ØªØ´ÙÙŠØ± Ø£Ø³Ø±Ø§Ø± TOTP/WebAuthn).


3. Ø¥Ù† ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Passwordless ÙƒØ¨Ø¯Ø§ÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ password = NULL ÙˆÙØ¹Ù‘Ù„ magic-link.




Ù…Ø§Ø°Ø§ Ø¨Ø¹Ø¯ØŸ

Ù„Ùˆ Ø­Ø§Ø¨Ø¨ Ø£ÙƒÙ…Ù„ Ù„Ùƒ:

Migrations Prisma Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù€SQL (+ seed script).

Endpoints Ø¬Ø§Ù‡Ø²Ø© (Express + JWT + TOTP/WebAuthn) Ù…Ø¹ Middlewares requirePermission ÙˆevaluatePolicy.

React Permission Manager Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© RTL.


Ù‚Ù„Ù‘ÙŠ: ØªØ­Ø¨ Ø£Ø·Ù„Ø¹ Ù„Ùƒ Skeleton backend Ø§Ù„Ø¢Ù†ØŒ ÙˆÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø¨Ù€ Permission ManagerØŸ (ÙˆØ¹Ø¯: Ù…Ø§ ÙÙŠ Ø²Ø± â€œØ£Ù†Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„â€ Ø¨Ø¯ÙˆÙ† Ù‚ÙÙ„ÙŠÙ† ÙˆÙ…ÙØªØ§Ø­ ğŸ˜„).

ØªÙ…Ø§Ù… ÙŠØ§ Ø¹Ù…Ø§Ø± â€” Ø¨Ø¯Ù„ Ù…Ø§ Ù†Ø³Ø£Ù„ â€œØ£Ø­Ø·Ù‘Ù‡ Ù‡Ù†Ø§ØŸâ€ØŒ Ø®Ù„Ù‘ÙŠÙ†ÙŠ Ø£Ù‚Ø¯Ù‘Ù… Ù„Ùƒ Ù…Ù„Ù SQL Ù…Ø¯Ù…Ø¬ ÙˆØ§Ø­Ø¯ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø® ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¢Ù†: ÙŠØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (RBAC + ABACØŒ Ø£Ø¬Ù‡Ø²Ø©/Ø¬Ù„Ø³Ø§ØªØŒ WebAuthnØŒ ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ£Ø¬Ø±ÙŠÙ† TenantsØŒ Ø³Ø¬Ù„Ø§Øª ØªØ¯Ù‚ÙŠÙ‚)ØŒ ÙÙ‡Ø§Ø±Ø³ØŒ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù„ÙŠØŒ Ù…Ø¹ seed Ù„Ø¯ÙˆØ± Ø§Ù„Ù€super-admin ÙˆØ£Ø¯ÙˆØ§Ø±/ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚ÙŠØ§Ø³ÙŠØ©. (Ø§Ø³ØªØ®Ø¯Ù…Ù‡ ÙƒÙ…Ø§ Ù‡Ùˆ Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ ÙˆØ¨Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ğŸ˜‰).

> PostgreSQL 14+ â€” ÙŠØ³ØªØ®Ø¯Ù… pgcrypto Ù„Ù€ gen_random_uuid().



-- =========================================================
-- Identity & Permissions SQL (All-in-One)  â€” v1.0
-- Author: You ğŸ«¶  | Environment: PostgreSQL 14+
-- =========================================================

-- 0) Extensions
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 1) Helper: updated_at trigger
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 2) Tenancy (optional but recommended)
CREATE TABLE IF NOT EXISTS tenants (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  plan TEXT DEFAULT 'free',
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE TRIGGER trg_tenants_updated_at
BEFORE UPDATE ON tenants FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 3) Users
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE SET NULL,
  email TEXT NOT NULL UNIQUE,
  password TEXT,                         -- bcrypt hash (NULL Ø¥Ø°Ø§ Passwordless ÙÙ‚Ø·)
  name TEXT,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_super_admin BOOLEAN NOT NULL DEFAULT FALSE,
  email_confirmed_at TIMESTAMP,
  totp_secret TEXT,                      -- Ø®Ø²Ù‘Ù†Ù‡ Ù…ÙØ´ÙÙ‘Ø±Ù‹Ø§ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_users_tenant ON users(tenant_id);
CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 4) Roles & Permissions (RBAC)
CREATE TABLE IF NOT EXISTS roles (
  id SERIAL PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  built_in BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, name)
);
CREATE TRIGGER trg_roles_updated_at
BEFORE UPDATE ON roles FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE IF NOT EXISTS permissions (
  id SERIAL PRIMARY KEY,
  key TEXT NOT NULL UNIQUE,              -- Ù…Ø«Ø§Ù„: users.read / users.* / settings.update
  description TEXT
);

CREATE TABLE IF NOT EXISTS role_permissions (
  role_id INT REFERENCES roles(id) ON DELETE CASCADE,
  permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,
  PRIMARY KEY (role_id, permission_id)
);

CREATE TABLE IF NOT EXISTS user_roles (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  role_id INT REFERENCES roles(id) ON DELETE CASCADE,
  PRIMARY KEY (user_id, role_id)
);

-- Overrides Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ABAC/RBAC hybrid)
CREATE TABLE IF NOT EXISTS user_permissions (
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  permission_id INT REFERENCES permissions(id) ON DELETE CASCADE,
  allowed BOOLEAN NOT NULL DEFAULT TRUE,
  PRIMARY KEY (user_id, permission_id)
);

-- 5) Access Policies (ABAC / policy-as-json)
CREATE TABLE IF NOT EXISTS access_policies (
  id SERIAL PRIMARY KEY,
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  policy_json JSONB NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, name)
);
CREATE TRIGGER trg_access_policies_updated_at
BEFORE UPDATE ON access_policies FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 6) Devices & Sessions
CREATE TABLE IF NOT EXISTS devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  device_name TEXT,
  device_type TEXT,            -- mobile/desktop/tablet/other
  browser TEXT,
  ip INET,
  last_seen TIMESTAMP NOT NULL DEFAULT NOW(),
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_devices_user ON devices(user_id);

-- Refresh tokens + Sessions (jti Ù„Ù„Ù€JWT)
CREATE TABLE IF NOT EXISTS sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id) ON DELETE SET NULL,
  user_agent TEXT,
  ip INET,
  jti TEXT UNIQUE,                         -- JWT ID (access) Ø¥Ù† ÙƒÙ†Øª ØªØ­ÙØ¸Ù‡
  refresh_token TEXT UNIQUE,               -- Ø®Ø²Ù‘Ù†Ù‡ Ù…ÙØ´ÙÙ‘Ø±Ù‹Ø§/Ù…ÙØ¬Ø²Ù‘Ø£Ù‹ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
  refresh_expires_at TIMESTAMP NOT NULL,
  revoked BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_sessions_user ON sessions(user_id);
CREATE INDEX IF NOT EXISTS idx_sessions_refresh_exp ON sessions(refresh_expires_at);
CREATE TRIGGER trg_sessions_updated_at
BEFORE UPDATE ON sessions FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 7) WebAuthn Credentials
CREATE TABLE IF NOT EXISTS webauthn_credentials (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  cred_id TEXT NOT NULL UNIQUE,            -- Base64URL
  public_key TEXT NOT NULL,
  sign_count BIGINT DEFAULT 0,
  transports TEXT[],                        -- ["usb","ble","nfc","internal"]
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_webauthn_user ON webauthn_credentials(user_id);

-- 8) OAuth Clients (Ù„Ù€OIDC/SSO Ø¯Ø§Ø®Ù„ÙŠ)
CREATE TABLE IF NOT EXISTS oauth_clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  client_id TEXT NOT NULL UNIQUE,
  client_secret TEXT NOT NULL,             -- Ø§Ø¹Ø±Ø¶Ù‡ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
  redirect_uris TEXT[] NOT NULL,
  scopes TEXT[] DEFAULT ARRAY[]::TEXT[],
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 9) Audit Logs
CREATE TABLE IF NOT EXISTS audit_logs (
  id BIGSERIAL PRIMARY KEY,
  tenant_id UUID,
  user_id UUID,
  action TEXT NOT NULL,                    -- ex: "auth.login", "admin.grant_permission"
  meta JSONB,
  ip INET,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_audit_tenant ON audit_logs(tenant_id);
CREATE INDEX IF NOT EXISTS idx_audit_user ON audit_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_audit_action ON audit_logs(action);

-- 10) Core Permissions seed (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙˆØ³Ù‘Ø¹)
INSERT INTO permissions(key, description) VALUES
  ('users.read','Read users'),
  ('users.create','Create users'),
  ('users.update','Update users'),
  ('users.delete','Delete users'),
  ('users.reset_password','Reset user password'),
  ('roles.read','Read roles'),
  ('roles.create','Create roles'),
  ('roles.update','Update roles'),
  ('roles.delete','Delete roles'),
  ('permissions.read','Read permissions'),
  ('permissions.assign','Assign permissions'),
  ('sessions.read','Read sessions'),
  ('sessions.revoke','Revoke sessions'),
  ('devices.read','Read devices'),
  ('devices.revoke','Revoke devices'),
  ('policies.read','Read ABAC policies'),
  ('policies.update','Update ABAC policies'),
  ('audit.read','Read audit logs'),
  ('impersonate.users','Impersonate users'),
  ('tenants.read','Read tenants'),
  ('tenants.update','Update tenants'),
  ('oauth.clients.manage','Manage OAuth clients'),
  ('signals.create','Create trading signals'),
  ('settings.*','All settings'),
  ('users.*','All users'),
  ('roles.*','All roles'),
  ('permissions.*','All permissions')
ON CONFLICT (key) DO NOTHING;

-- 11) Seed: default tenant + roles
DO $$
DECLARE
  t_id UUID;
  r_super INT;
  r_admin INT;
  r_support INT;
  r_readonly INT;
BEGIN
  -- Tenant
  INSERT INTO tenants(name, plan) VALUES ('Default Tenant','pro')
  ON CONFLICT DO NOTHING;

  SELECT id INTO t_id FROM tenants WHERE name='Default Tenant' LIMIT 1;

  -- Roles (built_in = true)
  INSERT INTO roles(tenant_id, name, description, built_in)
  VALUES
    (t_id, 'super-admin','All permissions', TRUE),
    (t_id, 'admin','Manage users, roles, settings (limited)', TRUE),
    (t_id, 'support','Support staff', TRUE),
    (t_id, 'readonly','Read-only access', TRUE)
  ON CONFLICT DO NOTHING;

  SELECT id INTO r_super FROM roles WHERE tenant_id=t_id AND name='super-admin';
  SELECT id INTO r_admin FROM roles WHERE tenant_id=t_id AND name='admin';
  SELECT id INTO r_support FROM roles WHERE tenant_id=t_id AND name='support';
  SELECT id INTO r_readonly FROM roles WHERE tenant_id=t_id AND name='readonly';

  -- Map permissions to roles
  -- super-admin: ÙƒÙ„ Ø´ÙŠØ¡
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_super, p.id FROM permissions p
  ON CONFLICT DO NOTHING;

  -- admin: Ù…Ø¹Ø¸Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ§Øª Ø¨Ø¯ÙˆÙ† impersonation Ø§Ù„ÙƒØ§Ù…Ù„
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_admin, p.id FROM permissions p
  WHERE p.key IN (
    'users.read','users.create','users.update','users.reset_password',
    'roles.read','roles.create','roles.update',
    'permissions.read','permissions.assign',
    'sessions.read','sessions.revoke',
    'devices.read','devices.revoke',
    'policies.read','policies.update',
    'audit.read',
    'tenants.read','tenants.update',
    'oauth.clients.manage',
    'signals.create'
  )
  ON CONFLICT DO NOTHING;

  -- support
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_support, p.id FROM permissions p
  WHERE p.key IN ('users.read','users.reset_password','sessions.read','devices.read','audit.read')
  ON CONFLICT DO NOTHING;

  -- readonly
  INSERT INTO role_permissions(role_id, permission_id)
  SELECT r_readonly, p.id FROM permissions p
  WHERE p.key IN ('users.read','roles.read','permissions.read','audit.read')
  ON CONFLICT DO NOTHING;

END $$;

-- 12) Seed: super admin user (DEV ONLY â€” Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙˆØ±Ù‹Ø§)
-- Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ Ù‡Ù†Ø§ hash Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (bcrypt) Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ NULL Ø¥Ù† ÙƒÙ†Øª Ø³ØªØ¨Ø¯Ø£ Ø¨Ù€ Passwordless.
-- Ù…Ø«Ø§Ù„ hash (ØªÙƒÙ…ÙŠÙ„ÙŠ/Ø§Ø®ØªØ¨Ø§Ø±ÙŠ): "$2b$12$KIXQG8e3pR2sJj2x4xQ2UOUjH9vKf0e5mQmQe2n3Tt8i2x9Y5Ww9a"
-- Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØºØ§Ù„Ø¨Ù‹Ø§ "ChangeMe!123" Ù…Ø¹ cost=12 (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù‚ÙŠÙ…ØªÙƒ).
DO $$
DECLARE
  t_id UUID;
  u_id UUID;
  r_super INT;
BEGIN
  SELECT id INTO t_id FROM tenants WHERE name='Default Tenant' LIMIT 1;
  SELECT id INTO r_super FROM roles WHERE tenant_id=t_id AND name='super-admin';

  INSERT INTO users(tenant_id, email, password, name, is_active, is_super_admin, email_confirmed_at)
  VALUES (t_id, 'admin@example.com',
          '$2b$12$KIXQG8e3pR2sJj2x4xQ2UOUjH9vKf0e5mQmQe2n3Tt8i2x9Y5Ww9a',
          'Super Admin', TRUE, TRUE, NOW())
  ON CONFLICT (email) DO NOTHING;

  SELECT id INTO u_id FROM users WHERE email='admin@example.com' LIMIT 1;

  IF u_id IS NOT NULL THEN
    INSERT INTO user_roles(user_id, role_id) VALUES (u_id, r_super)
    ON CONFLICT DO NOTHING;
  END IF;
END $$;

-- 13) Ù…Ø«Ø§Ù„ Policy JSON (ABAC) â€” Ø§Ø³Ù… ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø£ÙˆÙ„ÙŠØ©
INSERT INTO access_policies(tenant_id, name, description, policy_json, is_active)
SELECT t.id, 'signals.create.only_if_subscription_active_and_role',
       'Allow creating signals only if user has role trader and active subscription',
       '{
          "rules":[
            {"effect":"allow",
             "condition":{"and":[
               {"user.subscription.active": true},
               {"user.roles":{"contains":"trader"}}
             ]}}
          ]
        }'::jsonb,
       TRUE
FROM tenants t
WHERE NOT EXISTS (
  SELECT 1 FROM access_policies ap WHERE ap.tenant_id=t.id AND ap.name='signals.create.only_if_subscription_active_and_role'
);

-- 14) Hints/Indexes Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø£Ø¯Ø§Ø¡
CREATE INDEX IF NOT EXISTS idx_user_permissions_user ON user_permissions(user_id);
CREATE INDEX IF NOT EXISTS idx_role_permissions_role ON role_permissions(role_id);

-- 15) Ø£Ø°ÙˆÙ† Ø£Ø³Ù‡Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© (VIEWs Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
CREATE OR REPLACE VIEW v_user_effective_permissions AS
SELECT
  u.id AS user_id,
  p.key AS permission_key,
  COALESCE(up.allowed, TRUE) AS allowed,   -- override ÙŠØ¹Ù„Ùˆ Ø¹Ù„Ù‰ Ø¯ÙˆØ±â€¦ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  u.tenant_id
FROM users u
JOIN user_roles ur ON ur.user_id = u.id
JOIN roles r ON r.id = ur.role_id
JOIN role_permissions rp ON rp.role_id = r.id
JOIN permissions p ON p.id = rp.permission_id
LEFT JOIN user_permissions up ON up.user_id = u.id AND up.permission_id = p.id;

-- =========================================================
-- ØªÙ…. Ù„Ø§ ØªÙ†Ø³: ØºÙŠÙ‘Ø± Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù€super-admin ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ù‡ØŒ ÙˆØ´ØºÙ‘Ù„ 2FA/WebAuthn Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø·Ù„Ø§Ù‚.
-- =========================================================

Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹Ø©

Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°:

1. Ø¨Ø¯Ù‘Ù„ Ø¨Ø±ÙŠØ¯ ÙˆØ­Ù‚Ù„ password Ù„Ù„Ù€super-admin (hash Ø­Ù‚ÙŠÙ‚ÙŠ Ø¨ÙƒÙ„ÙØ© â‰¥ 12).


2. ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† (TLSØŒ Ù…ÙØ§ØªÙŠØ­ JWTØŒ ØªØ´ÙÙŠØ± Ø£Ø³Ø±Ø§Ø± TOTP/WebAuthn).


3. Ø¥Ù† ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù… Passwordless ÙƒØ¨Ø¯Ø§ÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ password = NULL ÙˆÙØ¹Ù‘Ù„ magic-link.




Ù…Ø§Ø°Ø§ Ø¨Ø¹Ø¯ØŸ

Ù„Ùˆ Ø­Ø§Ø¨Ø¨ Ø£ÙƒÙ…Ù„ Ù„Ùƒ:

Migrations Prisma Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù€SQL (+ seed script).

Endpoints Ø¬Ø§Ù‡Ø²Ø© (Express + JWT + TOTP/WebAuthn) Ù…Ø¹ Middlewares requirePermission ÙˆevaluatePolicy.

React Permission Manager Ø¨ÙˆØ§Ø¬Ù‡Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© RTL.


Ù‚Ù„Ù‘ÙŠ: ØªØ­Ø¨ Ø£Ø·Ù„Ø¹ Ù„Ùƒ Skeleton backend Ø§Ù„Ø¢Ù†ØŒ ÙˆÙ„Ø§ Ù†Ø¨Ø¯Ø£ Ø¨Ù€  ManagerØŸ (ÙˆØ¹Ø¯: Ù…Ø§ ÙÙŠ Ø²Ø± â€œØ£Ù†Ø§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„â€ Ø¨Ø¯ÙˆÙ† Ù‚ÙÙ„ÙŠÙ† ÙˆÙ…ÙØªØ§Ø­ ğŸ˜„).