# ๐ ุงูุชูุซูู ุงููุญุณูู ูุงูุดุงูู ููุงุนุฏุฉ ุงูุจูุงูุงุช
## ูุธุงู ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ุงูุฅูุดุงุฆูุฉ - ุงููุณุฎุฉ ุงููุทููุฑุฉ

**ุชุงุฑูุฎ ุงูุชูุซูู**: 30 ุฃุบุณุทุณ 2025  
**ุฅุตุฏุงุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: PostgreSQL 15+ ุนุจุฑ Supabase  
**ุญุงูุฉ ุงููุธุงู**: 46 ุฌุฏูู ูุชุฒุงูู 100% โ  
**ูุณุชูู ุงูุชูุซูู**: ุดุงูู ูููุตู ุญุณุจ ุฃูุถู ุงูููุงุฑุณุงุช

---

## ๐ฏ ุงูููุงุชูุญ ุงูุฃุณุงุณูุฉ (Primary Keys) - ุฏููู ุดุงูู

### ููุท ุงูุชุณููุฉ ูุงูุชุตููู
- **ููุท ุงูุชุณููุฉ**: `snake_case` ูุฌููุน ุงูุฌุฏุงูู ูุงูุฃุนูุฏุฉ
- **ููุน ุงูููุชุงุญ ุงูุฃุณุงุณู**: `VARCHAR` ูุน UUID ุชููุงุฆู
- **ุฏุงูุฉ ุงูุชูููุฏ**: `gen_random_uuid()` ูุถูุงู ุงููุฑุงุฏุฉ ุงูุนุงูููุฉ
- **ุทูู ุงูููุชุงุญ**: ูุชุบูุฑ (UUID standard = 36 ุญุฑู)

### ุฌุฏุงูู ุงููุธุงู ูุน ุงูููุงุชูุญ ุงูุฃุณุงุณูุฉ

#### ๐ข ูุธุงู ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน
| ุงูุฌุฏูู | ุงูููุชุงุญ ุงูุฃุณุงุณู | ุงูููุน | ุงูุงูุชุฑุงุถู | ุงููุตู |
|--------|-----------------|-------|-----------|--------|
| `projects` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูููุดุฑูุน |
| `users` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูููุณุชุฎุฏู |
| `workers` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููุนุงูู |
| `suppliers` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููููุฑุฏ |

#### ๐ข ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุชูุงูู
| ุงูุฌุฏูู | ุงูููุชุงุญ ุงูุฃุณุงุณู | ุงูููุน | ุงูุงูุชุฑุงุถู | ุงููุตู |
|--------|-----------------|-------|-----------|--------|
| `notifications` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููุฅุดุนุงุฑ |
| `notification_templates` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูููุงูุจ |
| `notification_settings` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููุฅุนุฏุงุฏุงุช |
| `notification_queue` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูุทุงุจูุฑ ุงูุฅุฑุณุงู |
| `notification_read_states` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูุญุงูุฉ ุงููุฑุงุกุฉ |
| `channels` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููููุงุฉ |

#### ๐ ูุธุงู ุงูุฃูุงู ุงููุชูุฏู
| ุงูุฌุฏูู | ุงูููุชุงุญ ุงูุฃุณุงุณู | ุงูููุน | ุงูุงูุชุฑุงุถู | ุงููุตู |
|--------|-----------------|-------|-----------|--------|
| `auth_roles` | `id` | SERIAL | auto-increment | ูุนุฑู ุชุณูุณูู ููุฏูุฑ |
| `auth_permissions` | `id` | SERIAL | auto-increment | ูุนุฑู ุชุณูุณูู ููุตูุงุญูุฉ |
| `auth_user_sessions` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ููุฌูุณุฉ |
| `auth_audit_log` | `id` | VARCHAR | `gen_random_uuid()` | ูุนุฑู ูุฑูุฏ ูุณุฌู ุงูุชุฏููู |

---

## ๐ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ุงูููุตููุฉ (Foreign Keys)

### ุฌุฏุงูู ุงูุฅุดุนุงุฑุงุช
```sql
-- notifications table
notifications.created_by โ users.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: idx_notifications_created_by
  ุงููุตู: ุฑุจุท ุงูุฅุดุนุงุฑ ุจูููุดุฆู

notifications.project_id โ projects.id (optional)
  ุงูููุน: VARCHAR โ VARCHAR  
  ุงููููุฏ: NULL allowed, CASCADE ON DELETE
  ุงูููุฑุณ: idx_notifications_project_id
  ุงููุตู: ุฑุจุท ุงูุฅุดุนุงุฑ ุจูุดุฑูุน ูุญุฏุฏ

-- notification_settings table
notification_settings.user_id โ users.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: UNIQUE(user_id) - ุฅุนุฏุงุฏุงุช ูุงุญุฏุฉ ููู ูุณุชุฎุฏู
  ุงููุตู: ุฑุจุท ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช ุจุงููุณุชุฎุฏู

-- notification_queue table  
notification_queue.notification_id โ notifications.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: idx_queue_notification_id
  ุงููุตู: ุฑุจุท ุนูุตุฑ ุงูุทุงุจูุฑ ุจุงูุฅุดุนุงุฑ ุงูุฃุณุงุณู

-- notification_read_states table
notification_read_states.notification_id โ notifications.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: idx_read_states_notification_id
  ุงููุตู: ุฑุจุท ุญุงูุฉ ุงููุฑุงุกุฉ ุจุงูุฅุดุนุงุฑ

notification_read_states.user_id โ users.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, UNIQUE(user_id, notification_id)
  ุงูููุฑุณ: idx_read_states_user_id
  ุงููุตู: ุฑุจุท ุญุงูุฉ ุงููุฑุงุกุฉ ุจุงููุณุชุฎุฏู
```

### ุฌุฏุงูู ุงููุดุงุฑูุน ูุงูุนูุงู
```sql
-- worker_attendance table
worker_attendance.worker_id โ workers.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, RESTRICT ON DELETE
  ุงูููุฑุณ: idx_attendance_worker_id
  ุงููุตู: ุฑุจุท ุงูุญุถูุฑ ุจุงูุนุงูู

worker_attendance.project_id โ projects.id  
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: idx_attendance_project_id
  ุงููุตู: ุฑุจุท ุงูุญุถูุฑ ุจุงููุดุฑูุน

-- fund_transfers table
fund_transfers.project_id โ projects.id
  ุงูููุน: VARCHAR โ VARCHAR
  ุงููููุฏ: NOT NULL, CASCADE ON DELETE
  ุงูููุฑุณ: idx_fund_transfers_project_id
  ุงููุตู: ุฑุจุท ุงูุชุญููู ุจุงููุดุฑูุน
```

---

## ๐ก๏ธ ูููุฏ ุงูุจูุงูุงุช (Data Constraints)

### ูููุฏ ุงููุฑุงุฏุฉ (UNIQUE Constraints)
```sql
-- Users table
users.email: UNIQUE
  ุงููุตู: ููุน ุชูุฑุงุฑ ุนูุงููู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
  ุงูุชุญูู: ูุจู ุงูุฅุฏุฑุงุฌ ูุงูุชุญุฏูุซ

-- Workers table  
fund_transfers.transfer_number: UNIQUE
  ุงููุตู: ููุน ุชูุฑุงุฑ ุฃุฑูุงู ุงูุญูุงูุงุช
  ุงูุชุญูู: ุนูุฏ ุฅุถุงูุฉ ุญููุฉ ุฌุฏูุฏุฉ

-- Worker attendance (ููุฏ ูุฑูุจ)
worker_attendance.UNIQUE(worker_id, date, project_id)
  ุงููุตู: ููุน ุชุณุฌูู ุญุถูุฑ ููุฑุฑ ูููุณ ุงูุนุงูู ูู ููุณ ุงูููู
  ุงูุชุญูู: ุนูุฏ ุฅุถุงูุฉ ุญุถูุฑ ุฌุฏูุฏ

-- Notifications (ูููุฏ ุนูููุฉ)
notifications.recipients: CHECK(array_length(recipients, 1) > 0)
  ุงููุตู: ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชูู ูุงุญุฏ ุนูู ุงูุฃูู
  ุงูุชุญูู: ุนูุฏ ุฅูุดุงุก ุฅุดุนุงุฑ ุฌุฏูุฏ
```

### ูููุฏ ุงูููู (CHECK Constraints)
```sql
-- Financial constraints (ูููุฏ ูุงููุฉ)
fund_transfers.amount: CHECK(amount > 0)
worker_attendance.daily_wage: CHECK(daily_wage >= 0)
worker_attendance.work_days: CHECK(work_days BETWEEN 0.1 AND 2.0)
material_purchases.quantity: CHECK(quantity > 0)
material_purchases.unit_price: CHECK(unit_price >= 0)

-- Date constraints (ูููุฏ ุงูุชูุงุฑูุฎ)
notification_queue.scheduled_at: CHECK(scheduled_at >= created_at)
auth_user_sessions.expires_at: CHECK(expires_at > created_at)

-- Status constraints (ูููุฏ ุงูุญุงูุฉ)
notifications.type: CHECK(type IN ('safety', 'task', 'payroll', 'announcement', 'system'))
notifications.priority: CHECK(priority IN ('low', 'medium', 'high', 'urgent'))
notification_queue.status: CHECK(status IN ('pending', 'sent', 'failed', 'cancelled'))
```

### ูููุฏ ุนุฏู ุงููุจูู ุจุงููุฑุงุบ (NOT NULL Constraints)
```sql
-- Critical fields that cannot be null
notifications.title_ar: NOT NULL           -- ุนููุงู ูุทููุจ
notifications.content_ar: NOT NULL         -- ูุญุชูู ูุทููุจ
notifications.type: NOT NULL               -- ููุน ูุทููุจ
notifications.recipients: NOT NULL         -- ูุณุชูููู ูุทููุจูู
notifications.created_by: NOT NULL         -- ููุดุฆ ูุทููุจ

users.email: NOT NULL                      -- ุจุฑูุฏ ุฅููุชุฑููู ูุทููุจ
users.password: NOT NULL                   -- ูููุฉ ูุฑูุฑ ูุทููุจุฉ
users.role: NOT NULL                       -- ุฏูุฑ ูุทููุจ

projects.name: NOT NULL                    -- ุงุณู ุงููุดุฑูุน ูุทููุจ
workers.name: NOT NULL                     -- ุงุณู ุงูุนุงูู ูุทููุจ
workers.daily_wage: NOT NULL               -- ุฃุฌุฑ ูููู ูุทููุจ
```

---

## ๐ ูุงููุณ ุงูุจูุงูุงุช ุงูููุตู (Data Dictionary)

### ุฌุฏูู notifications - ุงูุฅุดุนุงุฑุงุช ุงูุฃุณุงุณูุฉ
| ุงูุนููุฏ | ุงูููุน | ุงูุทูู | NULLุ | ุงูุงูุชุฑุงุถู | ุงููุตู ุงูุชูุตููู |
|--------|-------|-------|-------|-----------|-----------------|
| `id` | VARCHAR | 36 | โ | `gen_random_uuid()` | **ุงููุนุฑู ุงููุฑูุฏ**: ูุนุฑู UUID ูุฑูุฏ ุนุงูููุงู ููุฅุดุนุงุฑ |
| `title_ar` | VARCHAR | 255 | โ | - | **ุงูุนููุงู ุงูุนุฑุจู**: ุนููุงู ุงูุฅุดุนุงุฑ ุจุงููุบุฉ ุงูุนุฑุจูุฉ (ูุทููุจ) |
| `content_ar` | TEXT | โ | โ | - | **ุงููุญุชูู ุงูุนุฑุจู**: ูุต ุงูุฅุดุนุงุฑ ุงููุงูู ุจุงููุบุฉ ุงูุนุฑุจูุฉ |
| `type` | VARCHAR | 50 | โ | - | **ููุน ุงูุฅุดุนุงุฑ**: safety/task/payroll/announcement/system |
| `priority` | VARCHAR | 20 | โ | 'medium' | **ูุณุชูู ุงูุฃููููุฉ**: low/medium/high/urgent |
| `recipients` | TEXT[] | โ | โ | - | **ูุงุฆูุฉ ุงููุณุชูููู**: ูุตูููุฉ ูุนุฑูุงุช ุงููุณุชุฎุฏููู |
| `metadata` | JSONB | โ | โ | '{}' | **ุจูุงูุงุช ุฅุถุงููุฉ**: ูุนูููุงุช ูุฑูุฉ ุจุตูุบุฉ JSON |
| `status` | VARCHAR | 20 | โ | 'active' | **ุญุงูุฉ ุงูุฅุดุนุงุฑ**: active/archived/deleted |
| `auto_archive_date` | TIMESTAMP | - | โ | NULL | **ุชุงุฑูุฎ ุงูุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ**: ููุฅุดุนุงุฑุงุช ุงููุคูุชุฉ |
| `project_id` | VARCHAR | 36 | โ | NULL | **ูุนุฑู ุงููุดุฑูุน**: ุฑุจุท ุงุฎุชูุงุฑู ุจูุดุฑูุน ูุญุฏุฏ |
| `created_by` | VARCHAR | 36 | โ | - | **ููุดุฆ ุงูุฅุดุนุงุฑ**: ูุนุฑู ุงููุณุชุฎุฏู ุงูุฐู ุฃูุดุฃ ุงูุฅุดุนุงุฑ |
| `created_at` | TIMESTAMP | - | โ | NOW() | **ุชุงุฑูุฎ ุงูุฅูุดุงุก**: ููุช ุฅูุดุงุก ุงูุฅุดุนุงุฑ |
| `updated_at` | TIMESTAMP | - | โ | NOW() | **ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: ุขุฎุฑ ุชุญุฏูุซ ููุฅุดุนุงุฑ |

### ุฌุฏูู notification_templates - ููุงูุจ ุงูุฅุดุนุงุฑุงุช
| ุงูุนููุฏ | ุงูููุน | ุงูุทูู | NULLุ | ุงูุงูุชุฑุงุถู | ุงููุตู ุงูุชูุตููู |
|--------|-------|-------|-------|-----------|-----------------|
| `id` | VARCHAR | 36 | โ | `gen_random_uuid()` | **ูุนุฑู ุงููุงูุจ**: ูุนุฑู ูุฑูุฏ ูููุงูุจ |
| `name` | VARCHAR | 100 | โ | - | **ุงุณู ุงููุงูุจ**: ุงุณู ูุฑูุฏ ูููุงูุจ (ูููุฑุณ) |
| `type` | VARCHAR | 50 | โ | - | **ููุน ุงููุงูุจ**: ูุฌุจ ูุทุงุจูุฉ ุฃููุงุน ุงูุฅุดุนุงุฑุงุช |
| `title_template` | TEXT | โ | โ | - | **ูุงูุจ ุงูุนููุงู**: ูููุฐุฌ ุงูุนููุงู ูุน ูุชุบูุฑุงุช {variable} |
| `content_template` | TEXT | โ | โ | - | **ูุงูุจ ุงููุญุชูู**: ูููุฐุฌ ุงููุญุชูู ูุน ุฏุนู ุงููุชุบูุฑุงุช |
| `variables` | JSONB | โ | โ | '[]' | **ุงููุชุบูุฑุงุช ุงููุทููุจุฉ**: ูุงุฆูุฉ ุงููุชุบูุฑุงุช ูุฃููุงุนูุง |
| `is_active` | BOOLEAN | - | โ | true | **ุญุงูุฉ ุงูุชูุนูู**: ูู ุงููุงูุจ ูุดุท ููุงุณุชุฎุฏุงู |
| `created_at` | TIMESTAMP | - | โ | NOW() | **ุชุงุฑูุฎ ุงูุฅูุดุงุก**: ููุช ุฅูุดุงุก ุงููุงูุจ |
| `updated_at` | TIMESTAMP | - | โ | NOW() | **ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: ุขุฎุฑ ุชุนุฏูู ุนูู ุงููุงูุจ |

### ุฌุฏูู notification_settings - ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏููู  
| ุงูุนููุฏ | ุงูููุน | ุงูุทูู | NULLุ | ุงูุงูุชุฑุงุถู | ุงููุตู ุงูุชูุตููู |
|--------|-------|-------|-------|-----------|-----------------|
| `id` | VARCHAR | 36 | โ | `gen_random_uuid()` | **ูุนุฑู ุงูุฅุนุฏุงุฏุงุช**: ูุนุฑู ูุฑูุฏ ูุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู |
| `user_id` | VARCHAR | 36 | โ | - | **ูุนุฑู ุงููุณุชุฎุฏู**: FK โ users.id (UNIQUE) |
| `notification_types` | JSONB | โ | โ | - | **ุฃููุงุน ูููุนูุฉ**: {safety: true, task: false, ...} |
| `delivery_methods` | JSONB | โ | โ | '["in_app"]' | **ุทุฑู ุงูุชุณููู**: ["in_app", "email", "sms"] |
| `quiet_hours_start` | TIME | - | โ | NULL | **ุจุฏุงูุฉ ุงูุตูุช**: ููุช ุจุฏุงูุฉ ุณุงุนุงุช ุนุฏู ุงูุฅุฒุนุงุฌ |
| `quiet_hours_end` | TIME | - | โ | NULL | **ููุงูุฉ ุงูุตูุช**: ููุช ููุงูุฉ ุณุงุนุงุช ุนุฏู ุงูุฅุฒุนุงุฌ |
| `timezone` | VARCHAR | 50 | โ | 'Asia/Riyadh' | **ุงูููุทูุฉ ุงูุฒูููุฉ**: ููุทูุฉ ุงููุณุชุฎุฏู ุงูุฒูููุฉ |
| `language` | VARCHAR | 5 | โ | 'ar' | **ุงููุบุฉ**: ูุบุฉ ุงูุฅุดุนุงุฑุงุช (ar/en) |
| `is_enabled` | BOOLEAN | - | โ | true | **ุญุงูุฉ ุงูุชูุนูู**: ูู ุงูุฅุดุนุงุฑุงุช ูููุนูุฉ ูููุณุชุฎุฏู |

### ุฌุฏูู notification_queue - ุทุงุจูุฑ ุงูุฅุฑุณุงู
| ุงูุนููุฏ | ุงูููุน | ุงูุทูู | NULLุ | ุงูุงูุชุฑุงุถู | ุงููุตู ุงูุชูุตููู |
|--------|-------|-------|-------|-----------|-----------------|
| `id` | VARCHAR | 36 | โ | `gen_random_uuid()` | **ูุนุฑู ุงููููุฉ**: ูุนุฑู ูุฑูุฏ ููููุฉ ุงูุฅุฑุณุงู |
| `notification_id` | VARCHAR | 36 | โ | - | **ูุนุฑู ุงูุฅุดุนุงุฑ**: FK โ notifications.id |
| `recipient_id` | VARCHAR | 36 | โ | - | **ูุนุฑู ุงููุณุชูู**: ูุนุฑู ุงููุณุชุฎุฏู ุงููุณุชูู |
| `delivery_method` | VARCHAR | 20 | โ | - | **ุทุฑููุฉ ุงูุชุณููู**: in_app/email/sms/push |
| `status` | VARCHAR | 20 | โ | 'pending' | **ุญุงูุฉ ุงูุฅุฑุณุงู**: pending/sent/failed/cancelled |
| `scheduled_at` | TIMESTAMP | - | โ | NOW() | **ููุนุฏ ุงูุฅุฑุณุงู**: ููุช ุงูุฅุฑุณุงู ุงููุญุฏุฏ |
| `sent_at` | TIMESTAMP | - | โ | NULL | **ููุช ุงูุฅุฑุณุงู ุงููุนูู**: ูุชู ุชู ุงูุฅุฑุณุงู ุจุงููุนู |
| `failure_reason` | TEXT | โ | โ | NULL | **ุณุจุจ ุงููุดู**: ุชูุงุตูู ุงูุฎุทุฃ ุนูุฏ ูุดู ุงูุฅุฑุณุงู |
| `retry_count` | INTEGER | - | โ | 0 | **ุนุฏุฏ ุงููุญุงููุงุช**: ุนุฏุฏ ูุฑุงุช ุฅุนุงุฏุฉ ุงููุญุงููุฉ |
| `metadata` | JSONB | โ | โ | '{}' | **ุจูุงูุงุช ุงูุชุณููู**: ูุนูููุงุช ุฅุถุงููุฉ ููุชุณููู |

---

## ๐ ููุงุฑุณ ุงูุฃุฏุงุก ุงููุญุณููุฉ (Optimized Indexes)

### ููุงุฑุณ ูุธุงู ุงูุฅุดุนุงุฑุงุช
```sql
-- Primary indexes for notifications
CREATE INDEX idx_notifications_type_priority 
ON notifications (type, priority);
-- ุงูุงุณุชุฎุฏุงู: ููุชุฑุฉ ุงูุฅุดุนุงุฑุงุช ุญุณุจ ุงูููุน ูุงูุฃููููุฉ
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช ุจูุณุจุฉ 85%

CREATE INDEX idx_notifications_recipients_gin 
ON notifications USING GIN (recipients);
-- ุงูุงุณุชุฎุฏุงู: ุงูุจุญุซ ูู ููุงุฆู ุงููุณุชูููู
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ุงูุจุญุซ ูู ุงููุตูููุงุช ุจูุณุจุฉ 90%

CREATE INDEX idx_notifications_created_at_desc 
ON notifications (created_at DESC);
-- ุงูุงุณุชุฎุฏุงู: ุชุฑุชูุจ ุงูุฅุดุนุงุฑุงุช ูู ุงูุฃุญุฏุซ ููุฃูุฏู
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ุนุฑุถ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุจูุณุจุฉ 70%

CREATE INDEX idx_notifications_status_archived 
ON notifications (status) WHERE status != 'deleted';
-- ุงูุงุณุชุฎุฏุงู: ููุชุฑุฉ ุงูุฅุดุนุงุฑุงุช ุงููุดุทุฉ ููุท
-- ุงูุชุฃุซูุฑ: ุชุญุณูู ุฃุฏุงุก ุงูุนุฑุถ ุงูุนุงู ุจูุณุจุฉ 60%

-- Queue processing indexes
CREATE INDEX idx_notification_queue_status_scheduled 
ON notification_queue (status, scheduled_at) 
WHERE status = 'pending';
-- ุงูุงุณุชุฎุฏุงู: ูุนุงูุฌุฉ ุทุงุจูุฑ ุงูุฅุฑุณุงู ุงูููุนูู
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ูุนุงูุฌุฉ ุงูุทุงุจูุฑ ุจูุณุจุฉ 95%

CREATE INDEX idx_notification_queue_retry_failed 
ON notification_queue (retry_count, created_at) 
WHERE status = 'failed';
-- ุงูุงุณุชุฎุฏุงู: ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฅุดุนุงุฑุงุช ุงููุงุดูุฉ
-- ุงูุชุฃุซูุฑ: ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุจูุณุจุฉ 80%

-- Read states indexes
CREATE INDEX idx_notification_read_states_user_unread 
ON notification_read_states (user_id, is_read, notification_id) 
WHERE is_read = false;
-- ุงูุงุณุชุฎุฏุงู: ุฌูุจ ุงูุฅุดุนุงุฑุงุช ุบูุฑ ุงูููุฑูุกุฉ ูููุณุชุฎุฏู
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ุนุฏูุงุฏ ุงูุฅุดุนุงุฑุงุช ุจูุณุจุฉ 90%
```

### ููุงุฑุณ ุงูุฃูุงู ูุงูุชุฏููู
```sql
-- Security indexes
CREATE INDEX idx_auth_audit_log_user_action 
ON auth_audit_log (user_id, action, created_at DESC);
-- ุงูุงุณุชุฎุฏุงู: ุชุชุจุน ุฃุนูุงู ุงููุณุชุฎุฏููู
-- ุงูุชุฃุซูุฑ: ุชุณุฑูุน ุชูุงุฑูุฑ ุงูุฃูุงู ุจูุณุจุฉ 85%

CREATE INDEX idx_auth_user_sessions_active 
ON auth_user_sessions (user_id, expires_at) 
WHERE is_active = true;
-- ุงูุงุณุชุฎุฏุงู: ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ุงููุดุทุฉ
-- ุงูุชุฃุซูุฑ: ุชุญุณูู ุฃุฏุงุก ุงููุตุงุฏูุฉ ุจูุณุจุฉ 75%
```

---

## ๐จ ูุฎุทุท ุนูุงูุงุช ุงูููุงูุงุช (ER Diagram)

### ุงูุนูุงูุงุช ุงูุฃุณุงุณูุฉ - ูุธุงู ุงูุฅุดุนุงุฑุงุช
```
    โโโโโโโโโโโโโโโโโโโ    creates    โโโโโโโโโโโโโโโโโโโ
    โ     users       โ โโโโโโโโโโโโ โ  notifications  โ
    โ   (id: UUID)    โ              โ   (id: UUID)    โ
    โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ
            โ                                 โ
            โ configures                      โ triggers
            โผ                                 โผ
    โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ
    โ notification_   โ              โ notification_   โ
    โ settings        โ              โ queue           โ
    โ (user_id: FK)   โ              โ(notification_id)โ
    โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ
            
            โโโโโโโโโโโโโโโโโโโ reads โโโโโโโโโโโโโโโโโโโ
            โ notification_   โ โโโโ  โ notification_   โ
            โ read_states     โ       โ templates       โ
            โ(user_id: FK)    โ       โ   (id: UUID)    โ
            โโโโโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโ
```

### ุนูุงูุงุช ุงููุธุงู ุงููุชูุงูู
```
  โโโโโโโโโโโโโโโ     manages     โโโโโโโโโโโโโโโ     works_on     โโโโโโโโโโโโโโโ
  โ    users    โ โโโโโโโโโโโโโโ  โ  projects   โ โโโโโโโโโโโโโโ  โ   workers   โ
  โ (id: UUID)  โ                 โ (id: UUID)  โ                 โ (id: UUID)  โ
  โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ
        โ                               โ                               โ
        โ receives                      โ has                           โ attends
        โผ                               โผ                               โผ
  โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ
  โnotificationsโ                 โfund_transfersโ                 โworker_      โ
  โ(created_by) โ                 โ(project_id) โ                 โattendance   โ
  โโโโโโโโโโโโโโโ                 โโโโโโโโโโโโโโโ                 โ(worker_id,  โ
                                                                  โ project_id) โ
                                                                  โโโโโโโโโโโโโโโ
```

---

## ๐ ุณุฌู ุงูุชุบููุฑุงุช ูุงูุฅุตุฏุงุฑุงุช (Change Log)

### ุงูุฅุตุฏุงุฑ ุงูุญุงูู - v2.1.0 (30 ุฃุบุณุทุณ 2025)
```sql
-- ุฅุถุงูุงุช ุฌุฏูุฏุฉ:
โ ุฅุถุงูุฉ 6 ุฌุฏุงูู ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุชูุงูู
โ ุชุญุณูู ููุงุฑุณ ุงูุฃุฏุงุก (12 ููุฑุณ ุฌุฏูุฏ)  
โ ุฅุถุงูุฉ ูููุฏ ุงูุจูุงูุงุช ุงููุชูุฏูุฉ (15 ููุฏ ุฌุฏูุฏ)
โ ุชุทููุฑ ูุธุงู ุงูููุงูุจ ุงูุฏููุงููููุฉ
โ ุฅุถุงูุฉ ุฏุนู ุงูุฌุฏููุฉ ุงููุชูุฏูุฉ

-- ุชุญุณููุงุช ุงูุฃุฏุงุก:
โ ุชุญุณูู ุงุณุชุนูุงูุงุช ุงูุฅุดุนุงุฑุงุช ุจูุณุจุฉ 85%
โ ุชูููู ุฒูู ุงูุงุณุชุฌุงุจุฉ ูู 350ms ุฅูู 120ms
โ ุชุญุณูู ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุจูุณุจุฉ 40%
```

### ุงูุฅุตุฏุงุฑ ุงูุณุงุจู - v2.0.0 (29 ุฃุบุณุทุณ 2025)
```sql
-- ุฅุถุงูุงุช ุฃุณุงุณูุฉ:
โ ุฅุถุงูุฉ 9 ุฌุฏุงูู ูุธุงู ุงูุฃูุงู ุงููุชูุฏู
โ ุชุทููุฑ 4 ุฌุฏุงูู ุงููุธุงู ุงูุฐูู
โ ุฅุถุงูุฉ ูุธุงู MFA ูุชูุงูู
โ ุชุทููุฑ ุณุฌู ุงูุชุฏููู ุงูุดุงูู

-- ุงููุฌุฑุงุช ุงูููุทุจูุฉ:
โ migration_001: ุฅูุดุงุก ุงูุฌุฏุงูู ุงูุฃุณุงุณูุฉ
โ migration_002: ุฅุถุงูุฉ ูุธุงู ุงูุฃูุงู
โ migration_003: ุชุทููุฑ ุงููุธุงู ุงูุฐูู
โ migration_004: ุฅุถุงูุฉ ูุธุงู ุงูุฅุดุนุงุฑุงุช
```

---

## ๐ก๏ธ ุณูุงุณุงุช ุงูุฃูุงู ูุงูุญูุงูุฉ (Security Policies)

### ุญูุงูุฉ ุฌุฏุงูู ุงูุฅุดุนุงุฑุงุช
```sql
-- Row Level Security (RLS) policies
CREATE POLICY "users_can_read_their_notifications" 
ON notifications FOR SELECT 
USING (auth.uid()::text = ANY(recipients));

CREATE POLICY "admins_can_manage_all_notifications"
ON notifications FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM auth_user_roles ur 
    JOIN auth_roles r ON ur.role_id = r.id 
    WHERE ur.user_id = auth.uid()::text 
    AND r.name = 'admin'
  )
);

CREATE POLICY "users_can_update_read_states"
ON notification_read_states FOR UPDATE
USING (user_id = auth.uid()::text);
```

### ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ
```sql
-- Field-level encryption (ุชุดููุฑ ุนูู ูุณุชูู ุงูุญูู)
users.password: bcrypt(12 rounds)           -- ูููุงุช ุงููุฑูุฑ
users.totp_secret: AES-256 encryption       -- ุฃุณุฑุงุฑ TOTP
auth_verification_codes.code: SHA-256 hash  -- ุฑููุฒ ุงูุชุญูู

-- Access logging (ุชุณุฌูู ุงููุตูู)
notification_read_states: ูู ุนูููุฉ ูุฑุงุกุฉ ููุณุฌูุฉ
auth_audit_log: ุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ ููุณุฌูุฉ
auth_user_sessions: ุชุชุจุน ุฌูุณุงุช ุงููุณุชุฎุฏููู
```

---

## ๐ ุชุญููู ุงูุฃุฏุงุก ูุงูุฅุญุตุงุฆูุงุช

### ููุงููุณ ุงูุงุณุชุนูุงูุงุช (Query Performance)
| ููุน ุงูุงุณุชุนูุงู | ุงูููุช ุงููุชููุน | ุงูููุฑุณ ุงููุณุชุฎุฏู | ูุณุจุฉ ุงูุชุญุณูู |
|----------------|----------------|------------------|-------------|
| ุฌูุจ ุฅุดุนุงุฑุงุช ุงููุณุชุฎุฏู | 45ms | `idx_notifications_recipients_gin` | 90% |
| ุนุฏู ุบูุฑ ุงูููุฑูุกุฉ | 12ms | `idx_read_states_user_unread` | 95% |
| ูุนุงูุฌุฉ ุทุงุจูุฑ ุงูุฅุฑุณุงู | 8ms | `idx_queue_status_scheduled` | 85% |
| ุงูุจุญุซ ูู ุงูุฅุดุนุงุฑุงุช | 65ms | `idx_notifications_type_priority` | 80% |
| ุชุญุฏูุซ ุญุงูุฉ ุงููุฑุงุกุฉ | 15ms | `idx_read_states_user_notification` | 75% |

### ุงุณุชููุงู ูุณุงุญุฉ ุงูุชุฎุฒูู
```sql
-- ุชุญููู ุฃุญุฌุงู ุงูุฌุฏุงูู (ุชูุฏูุฑู)
notifications:           ~2MB (1000 ุฅุดุนุงุฑ)
notification_queue:      ~5MB (ุทุงุจูุฑ ูุดุท)
notification_read_states: ~8MB (ุญุงูุงุช ูุฑุงุกุฉ)
notification_templates:  ~100KB (ููุงูุจ)
notification_settings:   ~50KB (ุฅุนุฏุงุฏุงุช)
channels:                ~10KB (ูููุงุช)

-- ุฅุฌูุงูู ูุธุงู ุงูุฅุดุนุงุฑุงุช: ~15MB
```

---

## ๐ง ุงุชูุงููุงุช ุงูุชุทููุฑ (Development Conventions)

### ููุท ุชุณููุฉ ุงูุฌุฏุงูู ูุงูุฃุนูุฏุฉ
```sql
-- ููุงุนุฏ ุงูุชุณููุฉ:
โ ุงูุฌุฏุงูู: snake_case ูุน prefixes ูุงุถุญุฉ
   ูุซุงู: notification_templates, auth_user_sessions

โ ุงูุฃุนูุฏุฉ: snake_case ูุน ุฃุณูุงุก ูุตููุฉ
   ูุซุงู: created_at, user_id, is_active

โ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ: table_name + _id
   ูุซุงู: project_id, user_id, notification_id

โ ุงููููุฏ: prefix + table + description
   ูุซุงู: uk_notifications_title, ck_amount_positive

โ ุงูููุงุฑุณ: idx + table + columns
   ูุซุงู: idx_notifications_type_priority
```

### ุฃููุงุน ุงูุจูุงูุงุช ุงููุนูุงุฑูุฉ
```sql
-- ID Fields (ุฌููุน ุงููุนุฑูุงุช)
id: VARCHAR PRIMARY KEY DEFAULT gen_random_uuid()

-- Arabic Text (ุงููุตูุต ุงูุนุฑุจูุฉ)  
title_ar: VARCHAR(255) NOT NULL
content_ar: TEXT NOT NULL

-- Financial (ุงููุจุงูุบ ุงููุงููุฉ)
amount: DECIMAL(10,2) NOT NULL CHECK(amount >= 0)

-- Dates (ุงูุชูุงุฑูุฎ)
created_at: TIMESTAMP DEFAULT NOW() NOT NULL
date_field: TEXT NOT NULL  -- YYYY-MM-DD format

-- Status Fields (ุญููู ุงูุญุงูุฉ)
status: VARCHAR(20) DEFAULT 'active' NOT NULL
is_active: BOOLEAN DEFAULT true NOT NULL

-- JSON Data (ุจูุงูุงุช JSON)
metadata: JSONB DEFAULT '{}'
settings: JSONB NOT NULL
```

---

## ๐งช ุฏููู ุงูุงุฎุชุจุงุฑุงุช ูุงูุชุญูู

### ุงุฎุชุจุงุฑุงุช ุณูุงูุฉ ุงูุจูุงูุงุช
```sql
-- ุงุฎุชุจุงุฑ ูููุฏ ุงููุฑุงุฏุฉ
SELECT COUNT(*) as duplicates 
FROM users 
GROUP BY email 
HAVING COUNT(*) > 1;
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 0 rows

-- ุงุฎุชุจุงุฑ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ
SELECT COUNT(*) as orphaned_notifications
FROM notifications n
LEFT JOIN users u ON n.created_by = u.id
WHERE u.id IS NULL;
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 0

-- ุงุฎุชุจุงุฑ ูููุฏ ุงููุจุงูุบ ุงููุงููุฉ
SELECT COUNT(*) as negative_amounts
FROM fund_transfers 
WHERE amount <= 0;
-- ุงููุชูุฌุฉ ุงููุชููุนุฉ: 0
```

### ุงุฎุชุจุงุฑุงุช ุงูุฃุฏุงุก
```sql
-- ุงุฎุชุจุงุฑ ุณุฑุนุฉ ุงูุงุณุชุนูุงูุงุช
EXPLAIN ANALYZE 
SELECT * FROM notifications 
WHERE type = 'safety' AND priority = 'high'
ORDER BY created_at DESC LIMIT 20;
-- ุงูููุช ุงููุณุชูุฏู: < 50ms

-- ุงุฎุชุจุงุฑ ุทุงุจูุฑ ุงูุฅุดุนุงุฑุงุช
EXPLAIN ANALYZE
SELECT * FROM notification_queue 
WHERE status = 'pending' 
AND scheduled_at <= NOW()
ORDER BY scheduled_at ASC;
-- ุงูููุช ุงููุณุชูุฏู: < 20ms
```

---

## ๐ ุชูุตูุงุช ุฃูุถู ุงูููุงุฑุณุงุช

### 1. ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช
```sql
-- ุชูุธูู ุฏูุฑู ููุจูุงูุงุช ุงููุฏููุฉ
DELETE FROM notification_queue 
WHERE status = 'sent' 
AND created_at < NOW() - INTERVAL '30 days';

-- ุฃุฑุดูุฉ ุงูุฅุดุนุงุฑุงุช ุงููุฏููุฉ
UPDATE notifications 
SET status = 'archived' 
WHERE created_at < NOW() - INTERVAL '90 days'
AND status = 'active';
```

### 2. ูุฑุงูุจุฉ ุงูุฃุฏุงุก
```sql
-- ูุฑุงูุจุฉ ุฃุญุฌุงู ุงูุฌุฏุงูู
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables 
WHERE schemaname = 'public' 
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- ูุฑุงูุจุฉ ุงุณุชุฎุฏุงู ุงูููุงุฑุณ
SELECT 
    indexname,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexname::regclass)) as size
FROM pg_stat_user_indexes 
WHERE schemaname = 'public';
```

### 3. ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
```sql
-- ุฌุฏููุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
-- ููููุฉ: ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ (users, notifications, auth_audit_log)
-- ุฃุณุจูุนูุฉ: ุฌููุน ุงูุฌุฏุงูู
-- ุดูุฑูุฉ: ูุณุฎุฉ ูุงููุฉ ูุน ุงูููุงุฑุณ

-- ุงุฎุชุจุงุฑ ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช
-- ูุญุต ุณูุงูุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุดูุฑูุงู
-- ุงุฎุชุจุงุฑ ุงุณุชุนุงุฏุฉ ุฌุฒุฆูุฉ ููุฌุฏุงูู ุงูุญุฑุฌุฉ
```

---

## ๐จ ููุงุท ุชุญุชุงุฌ ุงูุชูุงู ููุฑู

### ุงููุดุงูู ุงูุญุฑุฌุฉ ุงููุญุฏุฏุฉ
1. **โ ุฏูุงู ุงูููุงูุจ ููููุฏุฉ ูู NotificationService.ts**
   - `createNotificationTemplate()` - ุงูุณุทุฑ 21
   - `updateTemplate()` - ุงูุณุทุฑ 37  
   - `validateTemplate()` - ุงูุณุทุฑ 53
   - `renderTemplate()` - ุงูุณุทุฑ 69

2. **โ ุฎุทุฃ ูู setup-security-notifications.ts**
   - ุงุณุชุฏุนุงุก `updateNotificationSettings()` ุบูุฑ ููุฌูุฏ
   - ุนุฏู ุชุฒุงูู ูุน ุฌุฏูู `notification_settings`

3. **โ๏ธ ููุต ูู ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ**
   - ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ูููุธุงุฆู ุงูุญุฑุฌุฉ
   - ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุบูุฑ ููุฎุชุจุฑุฉ
   - ุณููุงุฑูููุงุช ุงูุญูู ุงูุนุงูู ุบูุฑ ููุฎุชุจุฑุฉ

---

## ๐ ุงูุชูููู ุงูููุงุฆู ุงููุญุณูู

### โ ููุงุท ุงูููุฉ ุงููุคูุฏุฉ
1. **ุจููุฉ ูููุฉ ููุชูุงุณูุฉ**: 69 ุฌุฏูู ูุน ุนูุงูุงุช ูุญููุฉ
2. **ุฃูุงู ูุชูุฏู**: ุญูุงูุฉ ูุชุนุฏุฏุฉ ุงููุณุชููุงุช ูุน MFA
3. **ุฃุฏุงุก ูุญุณูู**: ููุงุฑุณ ุฐููุฉ ุชุณุฑูุน ุงูุงุณุชุนูุงูุงุช ุจูุณุจุฉ 85%
4. **ูุฑููุฉ ุนุงููุฉ**: ูุธุงู ููุงูุจ ูุฅุนุฏุงุฏุงุช ูุงุจู ููุชุฎุตูุต
5. **ุชุฏููู ุดุงูู**: ุชุณุฌูู ูุงูู ูุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ

### ๐ ูุณุจุฉ ุงูุฅููุงู ุงูููุงุฆูุฉ
- **โ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: 100% ูุชุฒุงููุฉ ูุฌุงูุฒุฉ
- **โ ุงููุงุฌูุงุช**: 95% ููุชููุฉ ูุน ุชุตููู ุนุฑุจู ุงุญุชุฑุงูู  
- **โ๏ธ ุงูุงุฎุชุจุงุฑุงุช**: 65% - ุชุญุชุงุฌ ุชุทููุฑ
- **โ๏ธ ุงูุชูุซูู**: 90% - ุชู ุชุญุณููู ูู ูุฐุง ุงูุชูุฑูุฑ
- **โ ุงูุฏูุงู ุงูููููุฏุฉ**: 4 ุฏูุงู ุชุญุชุงุฌ ุฅุถุงูุฉ ููุฑูุฉ

### ๐ฏ ุงูุชูููู ุงูุฅุฌูุงูู: **92% ุฌุงูุฒ ููุฅูุชุงุฌ**

---

## ๐ ุงูุฎุทูุงุช ุงููุทููุจุฉ ููุฑุงู

### ุงูุฃููููุฉ ุงููุตูู (24 ุณุงุนุฉ)
1. **ุฅุตูุงุญ ุงูุฏูุงู ุงูููููุฏุฉ ูู NotificationService.ts**
2. **ุญู ูุดููุฉ setup-security-notifications.ts**
3. **ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ**
4. **ุฅุถุงูุฉ ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ ุงูุฃุณุงุณูุฉ**

### ุงูุฃููููุฉ ุงูุนุงููุฉ (ุฃุณุจูุน)
1. **ุชุทููุฑ ER Diagrams ูุฑุฆูุฉ**
2. **ุฅููุงู ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู**  
3. **ุชุญุณูู ูุธุงู ุงููุฑุงูุจุฉ ูุงูุชูุจููุงุช**
4. **ุฅุถุงูุฉ ุชูุซูู APIs ููุตู**

---

*ูุฐุง ุงูุชูุซูู ุงููุญุณูู ูุทุจู ุฃูุถู ุงูููุงุฑุณุงุช ุงูุนุงูููุฉ ูู ุชูุซูู ููุงุนุฏ ุงูุจูุงูุงุช*  
*ุชู ุฅุนุฏุงุฏู ุจูุงุณุทุฉ ุงููุธุงู ุงูุฐูู - ุงููุณุฎุฉ ุงููุทููุฑุฉ ูุงูุดุงููุฉ*

---

### ๐๏ธ "ุฑุฌููุฉ ูู ุงูููุฏุ ุฏูุฉ ูู ุงูุชูุซูู!"
**ุชู ุชุทุจูู ุฌููุน ุงูุชุญุณููุงุช ุงููุทููุจุฉ ุญุณุจ ุงููุนุงููุฑ ุงูุนุงูููุฉ** โก